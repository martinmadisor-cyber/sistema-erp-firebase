<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ERP de Pagos Empresarial - Firebase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #64748b;
            --dark: #1f2937;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
            padding: 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { 
            font-size: 28px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .tabs {
            display: flex;
            background: #f8fafc;
            padding: 15px;
            gap: 10px;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 15px 25px;
            background: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 14px;
        }

        .tab:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tab.active { 
            background: var(--primary); 
            color: white; 
            transform: translateY(-3px);
        }

        .content { padding: 35px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group { display: flex; flex-direction: column; }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--gray); color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .stat-trend {
            font-size: 12px;
            color: var(--success);
            font-weight: 600;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-top: 25px;
        }

        table { width: 100%; border-collapse: collapse; }

        th {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 18px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td { padding: 18px; border-top: 1px solid #e5e7eb; font-size: 14px; }

        tr:hover { background: #f9fafb; }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-overdue { background: #fee2e2; color: #991b1b; }

        .alert {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 500;
        }

        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .alert-danger { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .import-area {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f9fafb;
        }

        .import-area:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .settings-panel {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e5e7eb;
        }

        .sync-panel {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border: 2px solid #10b981;
        }

        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
            border-left: 5px solid var(--primary);
        }

        .notification.show { transform: translateX(0); }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 12px; }
            .header { padding: 20px; flex-direction: column; text-align: center; gap: 15px; }
            .content { padding: 20px; }
            .form-grid, .stats-grid { grid-template-columns: 1fr; }
            .tabs { padding: 10px; justify-content: center; }
            .modal-content { width: 95%; padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 Sistema ERP Empresarial - Firebase</h1>
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">Inicializando...</span>
                <button class="btn btn-warning" onclick="exportData()">📊 Excel</button>
                <button class="btn btn-primary" id="firebaseToggle" onclick="toggleFirebaseMode()">☁️ Local</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', this)">📊 Dashboard</button>
            <button class="tab" onclick="showTab('invoices', this)">📄 Facturas</button>
            <button class="tab" onclick="showTab('products', this)">🛍️ Productos</button>
            <button class="tab" onclick="showTab('suppliers', this)">👥 Proveedores</button>
            <button class="tab" onclick="showTab('payments', this)">💳 Pagos</button>
            <button class="tab" onclick="showTab('import', this)">📥 Importador</button>
            <button class="tab" onclick="showTab('integrations', this)">🔗 Integraciones</button>
            <button class="tab" onclick="showTab('backup', this)">💾 Respaldo</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <div class="alert alert-info">
                    ℹ️ Sistema funcionando correctamente. Datos guardados localmente.
                </div>

                <div class="stats-grid">
                    <div class="stat-card" onclick="navigateToPending()">
                        <h3>Total Pendiente</h3>
                        <div class="stat-value" id="totalPending">$0</div>
                        <div class="stat-trend">💰 Facturas por pagar</div>
                    </div>
                    <div class="stat-card" onclick="navigateToOverdue()">
                        <h3>Facturas Vencidas</h3>
                        <div class="stat-value" id="overdueCount">0</div>
                        <div class="stat-trend">⚠️ Requieren atención</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSuppliers()">
                        <h3>Total Proveedores</h3>
                        <div class="stat-value" id="supplierCount">0</div>
                        <div class="stat-trend">👥 Proveedores activos</div>
                    </div>
                    <div class="stat-card" onclick="navigateToPayments()">
                        <h3>Pagos Realizados</h3>
                        <div class="stat-value" id="paymentCount">0</div>
                        <div class="stat-trend">💳 Pagos completados</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="dashboardChart"></canvas>
                </div>

                <div class="alert alert-success" id="statusAlert">
                    ✅ Sistema funcionando correctamente
                </div>
            </div>

            <div id="invoices" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2>📄 Gestión de Facturas</h2>
                    <div>
                        <select id="sortInvoices" onchange="sortInvoices()" style="padding: 10px; margin-right: 10px; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <option value="">Ordenar por...</option>
                            <option value="dueDate">Fecha Vencimiento (Próximas)</option>
                            <option value="dueDateDesc">Fecha Vencimiento (Lejanas)</option>
                            <option value="amount">Monto (Menor a Mayor)</option>
                            <option value="amountDesc">Monto (Mayor a Menor)</option>
                        </select>
                        <button class="btn btn-warning" onclick="checkPendingInvoices()">🔔 Verificar Vencimientos</button>
                        <button class="btn btn-danger" onclick="clearAllData()">🗑 Limpiar Todo</button>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Proveedor *</label>
                        <select id="supplierSelect" required>
                            <option value="">Seleccionar proveedor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Número de Factura *</label>
                        <input type="text" id="invoiceNumber" required placeholder="FAC-001">
                    </div>
                    <div class="form-group">
                        <label>Monto *</label>
                        <input type="number" id="amount" required step="1" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vencimiento *</label>
                        <input type="date" id="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label>Centro de Costo</label>
                        <input type="text" id="costCenter" placeholder="CC-001">
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea id="description" rows="2" placeholder="Detalles de la factura..."></textarea>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addInvoice()">➕ Agregar Factura</button>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Factura</th>
                                <th>Proveedor</th>
                                <th>Monto</th>
                                <th>Vencimiento</th>
                                <th>Centro Costo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="products" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2>🛍️ Gestión de Productos y Listas de Precio</h2>
                    <div>
                        <select id="priceListSelector" onchange="updateProductPrices()" style="padding: 10px; margin-right: 10px; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <option value="base">Precio Base</option>
                            <option value="lista1">Lista 1 (+20%)</option>
                            <option value="lista2">Lista 2 (+25%)</option>
                            <option value="lista5">Lista 5% (+5%)</option>
                            <option value="pvp">Lista PVP (+35%)</option>
                        </select>
                        <button class="btn btn-success" onclick="exportPriceList()">📋 Exportar Lista</button>
                        <button class="btn btn-primary" onclick="syncProductsToBSale()">🔄 Sync BSale</button>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Código de Producto *</label>
                        <input type="text" id="productCode" required placeholder="PROD-001">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Producto *</label>
                        <input type="text" id="productName" required placeholder="Nombre del producto">
                    </div>
                    <div class="form-group">
                        <label>Precio Base *</label>
                        <input type="number" id="productBasePrice" required step="1" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="productCategory">
                            <option value="general">General</option>
                            <option value="electronica">Electrónica</option>
                            <option value="ropa">Ropa</option>
                            <option value="hogar">Hogar</option>
                            <option value="servicios">Servicios</option>
                            <option value="construccion">Construcción</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" id="productStock" step="1" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea id="productDescription" rows="2" placeholder="Descripción del producto..."></textarea>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addProduct()" id="productSubmitBtn">➕ Agregar Producto</button>

                <div class="settings-panel" style="margin: 25px 0;">
                    <h3>🧮 Calculadora de Precios</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="stat-card" style="text-align: center;">
                            <h4>Lista 1 (+20%)</h4>
                            <div id="calcLista1" style="font-size: 20px; font-weight: bold; color: #3b82f6;">$0</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <h4>Lista 2 (+25%)</h4>
                            <div id="calcLista2" style="font-size: 20px; font-weight: bold; color: #10b981;">$0</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <h4>Lista 5% (+5%)</h4>
                            <div id="calcLista5" style="font-size: 20px; font-weight: bold; color: #f59e0b;">$0</div>
                        </div>
                        <div class="stat-card" style="text-align: center;">
                            <h4>Lista PVP (+35%)</h4>
                            <div id="calcPVP" style="font-size: 20px; font-weight: bold; color: #ef4444;">$0</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Precio Actual</th>
                                <th>Stock</th>
                                <th>Categoría</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="suppliers" class="tab-content">
                <h2>👥 Gestión de Proveedores</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="supplierName" required placeholder="Nombre del proveedor">
                    </div>
                    <div class="form-group">
                        <label>RUT/DNI *</label>
                        <input type="text" id="supplierRuc" required placeholder="12.345.678-9">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="supplierEmail" required placeholder="proveedor@email.com">
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="tel" id="supplierPhone" placeholder="+56 9 9999 9999">
                    </div>
                    <div class="form-group">
                        <label>Dirección</label>
                        <input type="text" id="supplierAddress" placeholder="Dirección completa">
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="supplierCategory">
                            <option value="servicios">Servicios</option>
                            <option value="productos">Productos</option>
                            <option value="consultoria">Consultoría</option>
                            <option value="tecnologia">Tecnología</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addSupplier()" id="supplierSubmitBtn">➕ Agregar Proveedor</button>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>RUT/DNI</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Categoría</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="payments" class="tab-content">
                <h2>💳 Historial de Pagos</h2>

                <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                    <input type="text" id="paymentSearch" placeholder="🔍 Buscar pagos..." onkeyup="searchPayments()">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha Pago</th>
                                <th>Factura</th>
                                <th>Proveedor</th>
                                <th>Monto</th>
                                <th>Método</th>
                                <th>Usuario</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="import" class="tab-content">
                <h2>📥 Importador Universal</h2>
                
                <div class="settings-panel">
                    <h3>📁 Formatos Soportados</h3>
                    <p><strong>Excel:</strong> .xlsx, .xls | <strong>CSV:</strong> .csv | <strong>JSON:</strong> .json</p>
                    <p><strong>DTE Chileno:</strong> Detecta automáticamente archivos de Documentos Tributarios Electrónicos</p>
                </div>

                <div class="import-area" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 20px;">📁</div>
                    <h3>Haz clic para seleccionar archivos</h3>
                    <p>Excel, CSV, JSON - Soporte especial para archivos DTE</p>
                    <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv,.json" style="display: none;" onchange="handleFileUpload(event)">
                </div>
            </div>

            <div id="integrations" class="tab-content">
                <h2>🔗 Integraciones Empresariales</h2>

                <div class="settings-panel" style="background: linear-gradient(135deg, #fff3e0, #ffecb3); border: 2px solid #ff9800;">
                    <h3>🔥 Configuración Firebase (Base de Datos en la Nube)</h3>
                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        ℹ️ Firebase te permite almacenar datos en la nube con 1GB gratis y sincronización automática entre dispositivos.
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>API Key de Firebase *</label>
                            <input type="password" id="firebaseApiKey" placeholder="AIzaSyC...">
                        </div>
                        <div class="form-group">
                            <label>Auth Domain *</label>
                            <input type="text" id="firebaseAuthDomain" placeholder="mi-erp-123456.firebaseapp.com">
                        </div>
                        <div class="form-group">
                            <label>Project ID *</label>
                            <input type="text" id="firebaseProjectId" placeholder="mi-erp-123456">
                        </div>
                        <div class="form-group">
                            <label>Storage Bucket</label>
                            <input type="text" id="firebaseStorageBucket" placeholder="mi-erp-123456.appspot.com">
                        </div>
                        <div class="form-group">
                            <label>Messaging Sender ID</label>
                            <input type="text" id="firebaseMessagingSenderId" placeholder="123456789">
                        </div>
                        <div class="form-group">
                            <label>App ID</label>
                            <input type="text" id="firebaseAppId" placeholder="1:123456789:web:abc123">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn btn-success" onclick="initializeFirebase()">🔥 Conectar Firebase</button>
                        <button class="btn btn-primary" onclick="migrateToFirebase()" id="migrateBtn" disabled>📤 Migrar Datos Locales</button>
                        <button class="btn btn-warning" onclick="downloadFromFirebase()" id="downloadBtn" disabled>📥 Descargar de Firebase</button>
                        <button class="btn btn-secondary" onclick="showFirebaseHelp()">❓ Ayuda Configuración</button>
                    </div>
                    
                    <div id="firebaseStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;">
                        <div id="firebaseStatusText"></div>
                    </div>
                </div>

                <div class="settings-panel sync-panel">
                    <h3>🛍️ Integración BSale</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Token de Acceso BSale</label>
                            <input type="password" id="bsaleToken" placeholder="Tu token de BSale">
                        </div>
                        <div class="form-group">
                            <label>URL Base</label>
                            <input type="url" id="bsaleUrl" value="https://api.bsale.io/v1/" placeholder="URL de la API">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="testBSaleConnection()">🔍 Probar Conexión</button>
                    <button class="btn btn-primary" onclick="syncBSale()">🔄 Sincronizar BSale</button>
                </div>

                <div class="settings-panel">
                    <h3>📧 Sistema de Alertas por Email</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Email Principal</label>
                            <input type="email" id="alertEmail" placeholder="admin@empresa.com">
                        </div>
                        <div class="form-group">
                            <label>Días de Anticipación</label>
                            <input type="number" id="alertDays" value="7" min="1" max="30">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="saveEmailSettings()">💾 Guardar</button>
                </div>

                <div class="settings-panel">
                    <h3>📱 Sistema de Alertas WhatsApp</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Número WhatsApp (con código país)</label>
                            <input type="tel" id="whatsappNumber" placeholder="+56912345678">
                        </div>
                        <div class="form-group">
                            <label>API Token WhatsApp (opcional)</label>
                            <input type="password" id="whatsappToken" placeholder="Token de WhatsApp Business API">
                        </div>
                        <div class="form-group">
                            <label>Días de anticipación</label>
                            <input type="number" id="whatsappDays" value="3" min="1" max="30">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="saveWhatsAppSettings()">💾 Guardar WhatsApp</button>
                    <button class="btn btn-primary" onclick="testWhatsAppAlert()">📱 Probar Alert</button>
                </div>

                <div class="settings-panel">
                    <h3>🐙 Sincronización GitHub</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Token GitHub</label>
                            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                        </div>
                        <div class="form-group">
                            <label>Repositorio</label>
                            <input type="text" id="githubRepo" placeholder="usuario/repo-erp">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="testGitHubConnection()">🔍 Probar GitHub</button>
                    <button class="btn btn-primary" onclick="syncToGitHub()">☁️ Subir a GitHub</button>
                </div>
            </div>

            <div id="backup" class="tab-content">
                <h2>💾 Centro de Respaldo</h2>
                
                <div class="settings-panel">
                    <h3>📊 Monitor de Almacenamiento</h3>
                    <div id="storageInfo" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Uso de almacenamiento local:</span>
                            <span id="storageUsage" style="font-weight: bold;">Calculando...</span>
                        </div>
                        <div style="background: #e5e7eb; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="storageBar" style="background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 5px;">
                            <span>0MB</span>
                            <span>~5MB límite</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="updateStorageInfo()">🔄 Actualizar Info</button>
                        <button class="btn btn-warning" onclick="optimizeStorage()" id="optimizeBtn">🧹 Limpiar Antiguos</button>
                        <button class="btn btn-danger" onclick="forceStorageCleanup()">⚡ Limpieza Forzada</button>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="stat-card">
                        <h3>📥 Respaldo Local</h3>
                        <p>Descarga todos tus datos en formato JSON</p>
                        <button class="btn btn-primary" onclick="createBackup()">📥 Crear Respaldo</button>
                    </div>
                    
                    <div class="stat-card">
                        <h3>📤 Restaurar Datos</h3>
                        <p>Cargar respaldo previo</p>
                        <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreBackup(event)">
                        <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">📤 Restaurar</button>
                    </div>

                    <div class="stat-card">
                        <h3>🗂️ Estadísticas de Datos</h3>
                        <div id="dataStats" style="font-size: 14px; line-height: 1.5;">
                            <div>Proveedores: <span id="statsSuppliers">0</span></div>
                            <div>Facturas: <span id="statsInvoices">0</span></div>
                            <div>Pagos: <span id="statsPay">0</span></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>⚙️ Herramientas de Mantenimiento</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-secondary" onclick="validateData()">✅ Validar Datos</button>
                            <button class="btn btn-warning" onclick="repairData()">🔧 Reparar Datos</button>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    ℹ️ Los datos se guardan automáticamente en tu navegador. Si el almacenamiento se llena, el sistema creará respaldos automáticos y optimizará los datos.
                </div>
            </div>
        </div>
    </div>

    <div id="editInvoiceModal" class="modal">
        <div class="modal-content">
            <h2>✏️ Editar Factura</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Proveedor *</label>
                    <select id="editSupplierSelect" required>
                        <option value="">Seleccionar proveedor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Número de Factura *</label>
                    <input type="text" id="editInvoiceNumber" required placeholder="FAC-001">
                </div>
                <div class="form-group">
                    <label>Monto *</label>
                    <input type="number" id="editAmount" required step="1" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Fecha de Vencimiento *</label>
                    <input type="date" id="editDueDate" required>
                </div>
                <div class="form-group">
                    <label>Centro de Costo</label>
                    <input type="text" id="editCostCenter" placeholder="CC-001">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea id="editDescription" rows="2" placeholder="Detalles de la factura..."></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button type="button" class="btn btn-warning" onclick="updateInvoice()">💾 Actualizar Factura</button>
                <button type="button" class="btn btn-danger" onclick="closeEditModal()">❌ Cancelar</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2 id="paymentModalTitle">💳 Registrar Pago</h2>
            <div class="form-group">
                <label>Fecha de Pago *</label>
                <input type="date" id="paymentDate" required>
            </div>
            <div class="form-group">
                <label>Método de Pago</label>
                <select id="paymentMethod">
                    <option value="transferencia">Transferencia</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="cheque">Cheque</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>
            <div class="form-group">
                <label>Referencia</label>
                <input type="text" id="paymentReference" placeholder="Número de operación">
            </div>
            <div class="form-group">
                <label>Notas</label>
                <textarea id="paymentNotes" rows="3" placeholder="Notas del pago..."></textarea>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button type="button" class="btn btn-success" id="paymentConfirmBtn" onclick="confirmPayment()">✅ Confirmar Pago</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">❌ Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let suppliers = JSON.parse(localStorage.getItem('suppliers') || '[]');
        let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        let payments = JSON.parse(localStorage.getItem('payments') || '[]');
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        let currentInvoice = null;
        let currentSupplier = null;
        let currentPayment = null;
        let currentEditInvoice = null;
        let currentProduct = null;
        let dashboardChart = null;
        let currentPriceList = 'base';

        // Firebase variables
        let firebase = null;
        let db = null;
        let isFirebaseMode = false;
        let firebaseUser = null;

        // Listas de precio - multiplicadores
        const priceMultipliers = {
            base: 1.0,
            lista1: 1.20,
            lista2: 1.25,
            lista5: 1.05,
            pvp: 1.35
        };

        // Configuraciones
        const config = {
            bsale: {
                token: localStorage.getItem('bsaleToken') || '',
                url: localStorage.getItem('bsaleUrl') || 'https://api.bsale.io/v1/'
            },
            email: {
                address: localStorage.getItem('alertEmail') || '',
                days: parseInt(localStorage.getItem('alertDays') || '7')
            },
            github: {
                token: localStorage.getItem('githubToken') || '',
                repo: localStorage.getItem('githubRepo') || ''
            },
            firebase: {
                apiKey: localStorage.getItem('firebaseApiKey') || '',
                authDomain: localStorage.getItem('firebaseAuthDomain') || '',
                projectId: localStorage.getItem('firebaseProjectId') || '',
                storageBucket: localStorage.getItem('firebaseStorageBucket') || '',
                messagingSenderId: localStorage.getItem('firebaseMessagingSenderId') || '',
                appId: localStorage.getItem('firebaseAppId') || ''
            }
        };

        // FUNCIONES CRUD PRODUCTOS
        function addProduct() {
            if (currentProduct) {
                updateProduct();
                return;
            }

            const product = {
                id: Date.now(),
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                basePrice: parseInt(document.getElementById('productBasePrice').value),
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                description: document.getElementById('productDescription').value || '',
                createdAt: new Date().toISOString(),
                bsaleId: null
            };

            if (!product.code || !product.name || !product.basePrice) {
                showNotification('Complete los campos obligatorios', 'warning');
                return;
            }

            // Verificar código único
            const exists = products.find(p => p.code === product.code);
            if (exists) {
                showNotification('El código de producto ya existe', 'warning');
                return;
            }

            products.push(product);
            saveData().then(() => {
                updateProductTable();
                clearProductForm();
                showNotification('Producto agregado correctamente', 'success');
            }).catch((error) => {
                showNotification('Error guardando producto', 'danger');
            });
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            currentProduct = product;
            
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productBasePrice').value = product.basePrice;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productStock').value = product.stock || 0;
            document.getElementById('productDescription').value = product.description || '';
            
            const submitBtn = document.getElementById('productSubmitBtn');
            submitBtn.textContent = '✏️ Actualizar Producto';
            submitBtn.className = 'btn btn-warning';
            
            // Actualizar calculadora
            updatePriceCalculator();
            
            showNotification('Modo edición de producto activado', 'info');
        }

        function updateProduct() {
            if (!currentProduct) return;

            const updatedData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                basePrice: parseInt(document.getElementById('productBasePrice').value),
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                description: document.getElementById('productDescription').value || '',
                updatedAt: new Date().toISOString()
            };

            if (!updatedData.code || !updatedData.name || !updatedData.basePrice) {
                showNotification('Complete los campos obligatorios', 'warning');
                return;
            }

            // Verificar código único (excluyendo el producto actual)
            const exists = products.find(p => p.code === updatedData.code && p.id !== currentProduct.id);
            if (exists) {
                showNotification('El código de producto ya existe', 'warning');
                return;
            }

            const index = products.findIndex(p => p.id === currentProduct.id);
            if (index !== -1) {
                products[index] = { ...products[index], ...updatedData };
                saveData().then(() => {
                    updateProductTable();
                    clearProductForm();
                    showNotification('Producto actualizado correctamente', 'success');
                });
            }
        }

        function deleteProduct(id) {
            if (confirm('¿Eliminar este producto?')) {
                products = products.filter(p => p.id !== id);
                
                // Eliminar de Firebase si está en modo nube
                deleteFromFirebase('products', id);
                
                saveData().then(() => {
                    updateProductTable();
                    showNotification('Producto eliminado', 'success');
                });
            }
        }

        function clearProductForm() {
            document.getElementById('productCode').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productBasePrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productDescription').value = '';
            
            const submitBtn = document.getElementById('productSubmitBtn');
            submitBtn.textContent = '➕ Agregar Producto';
            submitBtn.className = 'btn btn-primary';
            
            currentProduct = null;
            updatePriceCalculator();
        }

        // FUNCIONES DE LISTAS DE PRECIO
        function calculatePrice(basePrice, priceList) {
            return Math.round(basePrice * priceMultipliers[priceList]);
        }

        function updateProductPrices() {
            currentPriceList = document.getElementById('priceListSelector').value;
            updateProductTable();
            showNotification(`Vista cambiada a: ${getPriceListName(currentPriceList)}`, 'info');
        }

        function getPriceListName(listKey) {
            const names = {
                base: 'Precio Base',
                lista1: 'Lista 1 (+20%)',
                lista2: 'Lista 2 (+25%)',
                lista5: 'Lista 5% (+5%)',
                pvp: 'Lista PVP (+35%)'
            };
            return names[listKey] || 'Precio Base';
        }

        function updatePriceCalculator() {
            const basePrice = parseInt(document.getElementById('productBasePrice').value) || 0;
            
            document.getElementById('calcLista1').textContent = formatCurrency(calculatePrice(basePrice, 'lista1'));
            document.getElementById('calcLista2').textContent = formatCurrency(calculatePrice(basePrice, 'lista2'));
            document.getElementById('calcLista5').textContent = formatCurrency(calculatePrice(basePrice, 'lista5'));
            document.getElementById('calcPVP').textContent = formatCurrency(calculatePrice(basePrice, 'pvp'));
        }

        function exportPriceList() {
            if (products.length === 0) {
                showNotification('No hay productos para exportar', 'warning');
                return;
            }

            const currentList = document.getElementById('priceListSelector').value;
            const listName = getPriceListName(currentList);
            
            const exportData = products.map(product => ({
                'Código': product.code,
                'Producto': product.name,
                'Precio Base': product.basePrice,
                [`Precio ${listName}`]: calculatePrice(product.basePrice, currentList),
                'Stock': product.stock,
                'Categoría': product.category,
                'Descripción': product.description
            }));

            try {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData), listName);
                
                const fileName = `Lista-Precios-${currentList}-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`Lista de precios exportada: ${listName}`, 'success');
            } catch (error) {
                showNotification('Error exportando lista de precios', 'danger');
            }
        }

        function updateProductTable() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';

            products.forEach(function(product) {
                const currentPrice = calculatePrice(product.basePrice, currentPriceList);
                const stockStatus = product.stock > 10 ? 'En Stock' : product.stock > 0 ? 'Poco Stock' : 'Sin Stock';
                const stockClass = product.stock > 10 ? 'status-paid' : product.stock > 0 ? 'status-pending' : 'status-overdue';

                const row = tbody.insertRow();
                row.innerHTML = '<td><strong>' + product.code + '</strong></td>' +
                               '<td>' + product.name + '</td>' +
                               '<td style="font-weight: bold; color: var(--primary);">' + formatCurrency(currentPrice) + '</td>' +
                               '<td>' + product.stock + '</td>' +
                               '<td><span class="status-badge" style="background: #e0f2fe; color: #0277bd;">' + product.category + '</span></td>' +
                               '<td><span class="status-badge ' + stockClass + '">' + stockStatus + '</span></td>' +
                               '<td>' +
                               '<button class="btn btn-warning" onclick="editProduct(' + product.id + ')" style="margin-right: 5px;">✏️ Editar</button>' +
                               '<button class="btn btn-danger" onclick="deleteProduct(' + product.id + ')">🗑 Eliminar</button>' +
                               '</td>';
            });
        }

        // URL del backend proxy (cambiar por tu URL de Vercel)
        const PROXY_BASE_URL = 'https://sistema-erp-firebase.vercel.app/';

        // FUNCIONES DE INTEGRACIÓN BSALE - PRODUCTOS (USANDO PROXY)
        async function syncProductsToBSale() {
            if (!config.bsale.token) {
                showNotification('Configure primero el token BSale', 'warning');
                return;
            }

            try {
                showNotification('Sincronizando productos con BSale...', 'info');
                
                let syncCount = 0;
                
                for (let product of products) {
                    if (!product.bsaleId) {
                        // Crear producto en BSale usando proxy
                        const bsaleProduct = {
                            name: product.name,
                            description: product.description,
                            code: product.code,
                            basePrice: product.basePrice,
                            productType: { id: 1 }, // Producto
                            state: 0, // Activo
                            allowDecimal: 0,
                            stockControl: 1
                        };

                        const response = await fetch(`${PROXY_BASE_URL}/api/products?token=${config.bsale.token}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(bsaleProduct)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            
                            // Actualizar producto local con ID de BSale
                            const productIndex = products.findIndex(p => p.id === product.id);
                            if (productIndex !== -1) {
                                products[productIndex].bsaleId = result.id;
                                syncCount++;
                            }
                        } else {
                            const error = await response.json();
                            throw new Error(error.details || error.error);
                        }
                    }
                }

                await saveData();
                updateProductTable();
                showNotification(`Sincronización completada: ${syncCount} productos enviados a BSale`, 'success');

            } catch (error) {
                showNotification('Error sincronizando productos con BSale: ' + error.message, 'danger');
            }
        }

        // FUNCIONES DE ENVÍO DE FACTURAS A BSALE (USANDO PROXY)
        async function sendInvoiceToBSale(invoiceId) {
            const invoice = invoices.find(i => i.id === invoiceId);
            if (!invoice) {
                showNotification('Factura no encontrada', 'danger');
                return;
            }

            if (!config.bsale.token) {
                showNotification('Configure primero el token BSale', 'warning');
                return;
            }

            try {
                showNotification('Enviando factura a BSale...', 'info');

                // Buscar cliente en BSale por RUT usando proxy
                const supplier = suppliers.find(s => s.id === invoice.supplierId);
                let clientId = null;

                if (supplier && supplier.ruc) {
                    const clientResponse = await fetch(`${PROXY_BASE_URL}/api/clients?token=${config.bsale.token}&code=${supplier.ruc}`);

                    if (clientResponse.ok) {
                        const clientData = await clientResponse.json();
                        if (clientData.items && clientData.items.length > 0) {
                            clientId = clientData.items[0].id;
                        } else {
                            // Crear cliente en BSale si no existe
                            const newClient = {
                                firstName: supplier.name,
                                lastName: '',
                                code: supplier.ruc,
                                email: supplier.email,
                                phone: supplier.phone,
                                address: supplier.address,
                                municipality: 'Santiago',
                                state: 0 // Activo
                            };

                            const createClientResponse = await fetch(`${PROXY_BASE_URL}/api/clients?token=${config.bsale.token}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(newClient)
                            });

                            if (createClientResponse.ok) {
                                const createdClient = await createClientResponse.json();
                                clientId = createdClient.id;
                            }
                        }
                    }
                }

                // Crear factura en BSale usando proxy
                const bsaleDocument = {
                    documentTypeId: 1, // Factura electrónica
                    number: invoice.invoiceNumber,
                    emissionDate: Math.floor(new Date(invoice.createdAt).getTime() / 1000),
                    expirationDate: Math.floor(new Date(invoice.dueDate).getTime() / 1000),
                    totalAmount: invoice.amount,
                    netAmount: Math.round(invoice.amount / 1.19), // Asumiendo IVA 19%
                    taxAmount: Math.round(invoice.amount - (invoice.amount / 1.19)),
                    exemptAmount: 0,
                    exportTotalAmount: 0,
                    exportNetAmount: 0,
                    exportTaxAmount: 0,
                    exportExemptAmount: 0,
                    informedSii: 0,
                    responseMsg: '',
                    state: 0, // Borrador
                    commercialState: 0, // Pendiente
                    urlTimbre: '',
                    ted: '',
                    urlPublicView: '',
                    urlPdf: '',
                    urlPublicViewOriginal: '',
                    urlPdfOriginal: '',
                    token: '',
                    tipoDte: '',
                    informedSiiDate: null,
                    serviceTotalAmount: 0,
                    itemTotalAmount: invoice.amount,
                    itemTaxAmount: Math.round(invoice.amount - (invoice.amount / 1.19)),
                    itemNetAmount: Math.round(invoice.amount / 1.19),
                    itemExemptAmount: 0,
                    address: supplier ? supplier.address : '',
                    municipality: 'Santiago',
                    city: 'Santiago',
                    client: clientId ? { id: clientId } : null,
                    details: [{
                        lineNumber: 1,
                        quantity: 1,
                        unitValue: Math.round(invoice.amount / 1.19),
                        taxAmount: Math.round(invoice.amount - (invoice.amount / 1.19)),
                        totalAmount: invoice.amount,
                        netAmount: Math.round(invoice.amount / 1.19),
                        exemptAmount: 0,
                        comment: invoice.description || 'Factura generada desde ERP',
                        relatedDetailId: 0,
                        relatedDetailQuantity: 0
                    }]
                };

                const documentResponse = await fetch(`${PROXY_BASE_URL}/api/documents?token=${config.bsale.token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bsaleDocument)
                });

                if (documentResponse.ok) {
                    const result = await documentResponse.json();
                    
                    // Actualizar factura local con ID de BSale
                    const invoiceIndex = invoices.findIndex(i => i.id === invoice.id);
                    if (invoiceIndex !== -1) {
                        invoices[invoiceIndex].bsaleId = result.id;
                        invoices[invoiceIndex].bsaleUrl = result.urlPublicView;
                    }

                    await saveData();
                    updateInvoiceTable();
                    showNotification('Factura enviada a BSale correctamente', 'success');
                } else {
                    const error = await documentResponse.json();
                    throw new Error(error.details || error.error);
                }

            } catch (error) {
                showNotification('Error enviando factura a BSale: ' + error.message, 'danger');
            }
        }

        async function testBSaleConnection() {
            const token = document.getElementById('bsaleToken').value;
            if (!token) {
                showNotification('Ingrese el token de BSale', 'warning');
                return;
            }

            try {
                showNotification('Probando conexión con BSale...', 'info');
                
                // ✅ AHORA USA EL PROXY DE VERCEL
                const response = await fetch(`/api/bsale-proxy?token=${encodeURIComponent(token)}&endpoint=clients.json`);

                if (response.ok) {
                    const data = await response.json();
                    config.bsale.token = token;
                    localStorage.setItem('bsaleToken', token);
                    showNotification(`✅ Conexión exitosa! ${data.count || 0} clientes encontrados`, 'success');
                } else {
                    const error = await response.json();
                    showNotification(`❌ Error: ${error.details || error.error}`, 'danger');
                }
            } catch (error) {
                showNotification('❌ Error de conexión: ' + error.message, 'danger');
                console.error('Error completo:', error);
            }
        }
        function initializeFirebase() {
            const apiKey = document.getElementById('firebaseApiKey').value;
            const authDomain = document.getElementById('firebaseAuthDomain').value;
            const projectId = document.getElementById('firebaseProjectId').value;
            const storageBucket = document.getElementById('firebaseStorageBucket').value;
            const messagingSenderId = document.getElementById('firebaseMessagingSenderId').value;
            const appId = document.getElementById('firebaseAppId').value;

            if (!apiKey || !authDomain || !projectId) {
                showNotification('Complete los campos obligatorios de Firebase', 'warning');
                return;
            }

            const firebaseConfig = {
                apiKey: apiKey,
                authDomain: authDomain,
                projectId: projectId,
                storageBucket: storageBucket,
                messagingSenderId: messagingSenderId,
                appId: appId
            };

            try {
                // Guardar configuración
                config.firebase = firebaseConfig;
                Object.keys(firebaseConfig).forEach(key => {
                    localStorage.setItem('firebase' + key.charAt(0).toUpperCase() + key.slice(1), firebaseConfig[key]);
                });

                // Inicializar Firebase
                if (window.firebase && window.firebase.apps.length === 0) {
                    firebase = window.firebase.initializeApp(firebaseConfig);
                } else if (window.firebase && window.firebase.apps.length > 0) {
                    firebase = window.firebase.app();
                }

                db = firebase.firestore();
                
                // Habilitar persistencia offline
                db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                    console.warn('Persistencia Firebase no disponible:', err);
                });

                updateFirebaseStatus('Conectado a Firebase', 'success');
                document.getElementById('migrateBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;
                
                // Actualizar indicador de sincronización
                updateSyncStatus('firebase', 'Conectado a Firebase');
                
                showNotification('Firebase conectado correctamente', 'success');
                
            } catch (error) {
                updateFirebaseStatus('Error: ' + error.message, 'error');
                showNotification('Error conectando Firebase: ' + error.message, 'danger');
            }
        }

        function toggleFirebaseMode() {
            const button = document.getElementById('firebaseToggle');
            
            if (!isFirebaseMode && (!db || !firebase)) {
                showNotification('Primero configure y conecte Firebase', 'warning');
                return;
            }
            
            isFirebaseMode = !isFirebaseMode;
            localStorage.setItem('firebaseMode', isFirebaseMode.toString());
            
            if (isFirebaseMode) {
                button.textContent = '☁️ Firebase';
                button.className = 'btn btn-success';
                updateSyncStatus('firebase', 'Modo Firebase activo');
                showNotification('Cambiado a modo Firebase - Datos en la nube', 'success');
            } else {
                button.textContent = '💾 Local';
                button.className = 'btn btn-primary';
                updateSyncStatus('local', 'Modo local activo');
                showNotification('Cambiado a modo Local - Datos en navegador', 'info');
            }
        }

        function updateSyncStatus(mode, message) {
            const indicator = document.getElementById('syncIndicator');
            const status = document.getElementById('syncStatus');
            
            if (mode === 'firebase') {
                indicator.style.background = '#10b981';
                indicator.style.animation = 'pulse 2s infinite';
                status.textContent = message;
            } else if (mode === 'local') {
                indicator.style.background = '#3b82f6';
                indicator.style.animation = 'pulse 2s infinite';
                status.textContent = message;
            } else if (mode === 'error') {
                indicator.style.background = '#ef4444';
                indicator.style.animation = 'none';
                status.textContent = message;
            }
        }

        function updateFirebaseStatus(message, type) {
            const statusDiv = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            
            if (type === 'success') {
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                statusDiv.style.border = '1px solid #10b981';
            } else if (type === 'error') {
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.style.border = '1px solid #ef4444';
            } else {
                statusDiv.style.background = '#dbeafe';
                statusDiv.style.color = '#1e40af';
                statusDiv.style.border = '1px solid #3b82f6';
            }
        }

        async function migrateToFirebase() {
            if (!db) {
                showNotification('Firebase no está conectado', 'danger');
                return;
            }

            if (!confirm('¿Migrar todos los datos locales a Firebase? Esto sobrescribirá los datos existentes en la nube.')) {
                return;
            }

            try {
                showNotification('Migrando datos a Firebase...', 'info');
                updateFirebaseStatus('Migrando datos...', 'info');

                const batch = db.batch();
                
                // Migrar proveedores
                const suppliersRef = db.collection('suppliers');
                for (let supplier of suppliers) {
                    const docRef = suppliersRef.doc(supplier.id.toString());
                    batch.set(docRef, supplier);
                }

                // Migrar facturas
                const invoicesRef = db.collection('invoices');
                for (let invoice of invoices) {
                    const docRef = invoicesRef.doc(invoice.id.toString());
                    batch.set(docRef, invoice);
                }

                // Migrar pagos
                const paymentsRef = db.collection('payments');
                for (let payment of payments) {
                    const docRef = paymentsRef.doc(payment.id.toString());
                    batch.set(docRef, payment);
                }

                // Migrar productos
                const productsRef = db.collection('products');
                for (let product of products) {
                    const docRef = productsRef.doc(product.id.toString());
                    batch.set(docRef, product);
                }

                await batch.commit();

                updateFirebaseStatus('Migración completada exitosamente', 'success');
                showNotification(`Migración completada: ${suppliers.length} proveedores, ${invoices.length} facturas, ${payments.length} pagos, ${products.length} productos`, 'success');
                
                // Activar modo Firebase automáticamente
                if (!isFirebaseMode) {
                    toggleFirebaseMode();
                }

            } catch (error) {
                updateFirebaseStatus('Error en migración: ' + error.message, 'error');
                showNotification('Error migrando datos: ' + error.message, 'danger');
            }
        }

        async function downloadFromFirebase() {
            if (!db) {
                showNotification('Firebase no está conectado', 'danger');
                return;
            }

            try {
                showNotification('Descargando datos de Firebase...', 'info');
                updateFirebaseStatus('Descargando datos...', 'info');

                // Descargar proveedores
                const suppliersSnapshot = await db.collection('suppliers').get();
                const firebaseSuppliers = [];
                suppliersSnapshot.forEach(doc => {
                    firebaseSuppliers.push({ id: doc.id, ...doc.data() });
                });

                // Descargar facturas
                const invoicesSnapshot = await db.collection('invoices').get();
                const firebaseInvoices = [];
                invoicesSnapshot.forEach(doc => {
                    firebaseInvoices.push({ id: doc.id, ...doc.data() });
                });

                // Descargar pagos
                const paymentsSnapshot = await db.collection('payments').get();
                const firebasePayments = [];
                paymentsSnapshot.forEach(doc => {
                    firebasePayments.push({ id: doc.id, ...doc.data() });
                });

                // Descargar productos
                const productsSnapshot = await db.collection('products').get();
                const firebaseProducts = [];
                productsSnapshot.forEach(doc => {
                    firebaseProducts.push({ id: doc.id, ...doc.data() });
                });

                // Actualizar datos locales
                suppliers = firebaseSuppliers;
                invoices = firebaseInvoices;
                payments = firebasePayments;
                products = firebaseProducts;

                // Guardar en localStorage como respaldo
                saveDataLocal();
                updateAll();

                updateFirebaseStatus('Descarga completada exitosamente', 'success');
                showNotification(`Descarga completada: ${suppliers.length} proveedores, ${invoices.length} facturas, ${payments.length} pagos, ${products.length} productos`, 'success');

            } catch (error) {
                updateFirebaseStatus('Error en descarga: ' + error.message, 'error');
                showNotification('Error descargando datos: ' + error.message, 'danger');
            }
        }

        function showFirebaseHelp() {
            const helpText = `
🔥 CONFIGURACIÓN DE FIREBASE

1. Ve a https://console.firebase.google.com/
2. Crea un nuevo proyecto o selecciona uno existente
3. Ve a "Configuración del proyecto" > "General"
4. En "Tus apps", crea una nueva app web
5. Copia la configuración que aparece:

const firebaseConfig = {
  apiKey: "AIza...",
  authDomain: "tu-proyecto.firebaseapp.com",
  projectId: "tu-proyecto",
  storageBucket: "tu-proyecto.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abc123"
};

6. Pega cada valor en los campos correspondientes
7. En Firebase Console, ve a "Firestore Database"
8. Crea una base de datos en modo "test" o "production"
9. Configura las reglas de seguridad según tus necesidades

REGLAS DE FIRESTORE RECOMENDADAS:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true; // Para pruebas solamente
    }
  }
}
            `;

            alert(helpText);
        }

        // FUNCIÓN PRINCIPAL DE CAMBIO DE TABS
        function showTab(tabName, button) {
            // Remover active de todos los tabs
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            // Remover active de todos los contenidos
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            
            // Activar el tab seleccionado
            button.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Actualizar dashboard si es necesario
            if (tabName === 'dashboard') {
                updateDashboard();
                setTimeout(initializeChart, 100);
            }
        }

        // FUNCIONES DE NAVEGACIÓN DEL DASHBOARD
        function navigateToPending() {
            showTab('invoices', document.querySelectorAll('.tab')[1]);
            showNotification('Mostrando todas las facturas pendientes', 'info');
        }

        function navigateToOverdue() {
            showTab('invoices', document.querySelectorAll('.tab')[1]);
            showNotification('Revisa las facturas vencidas en rojo', 'warning');
        }

        function navigateToSuppliers() {
            showTab('suppliers', document.querySelectorAll('.tab')[2]);
            showNotification('Gestión de proveedores', 'info');
        }

        function navigateToPayments() {
            showTab('payments', document.querySelectorAll('.tab')[3]);
            showNotification('Historial de pagos realizados', 'info');
        }

        // FUNCIONES DE EDICIÓN DE FACTURAS
        function editInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!invoice) return;

            currentEditInvoice = invoice;
            
            // Actualizar el select de proveedores en el modal de edición
            updateEditSupplierSelect();
            
            // Llenar el formulario con los datos de la factura
            document.getElementById('editSupplierSelect').value = invoice.supplierId || '';
            document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('editAmount').value = invoice.amount;
            document.getElementById('editDueDate').value = invoice.dueDate;
            document.getElementById('editCostCenter').value = invoice.costCenter || '';
            document.getElementById('editDescription').value = invoice.description || '';
            
            // Mostrar modal
            document.getElementById('editInvoiceModal').classList.add('active');
            showNotification('Modo edición de factura activado', 'info');
        }

        function updateEditSupplierSelect() {
            const select = document.getElementById('editSupplierSelect');
            select.innerHTML = '<option value="">Seleccionar proveedor</option>';

            suppliers.forEach(function(supplier) {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
        }

        function updateInvoice() {
            if (!currentEditInvoice) return;

            const selectEl = document.getElementById('editSupplierSelect');
            const updatedData = {
                supplierId: selectEl.value,
                supplierName: selectEl.options[selectEl.selectedIndex].text,
                invoiceNumber: document.getElementById('editInvoiceNumber').value,
                amount: parseInt(document.getElementById('editAmount').value),
                dueDate: document.getElementById('editDueDate').value,
                costCenter: document.getElementById('editCostCenter').value || '',
                description: document.getElementById('editDescription').value || ''
            };

            if (!updatedData.supplierId || !updatedData.invoiceNumber || !updatedData.amount || !updatedData.dueDate) {
                showNotification('Complete todos los campos obligatorios', 'warning');
                return;
            }

            const index = invoices.findIndex(i => i.id === currentEditInvoice.id);
            if (index !== -1) {
                invoices[index] = { ...invoices[index], ...updatedData };
                saveData();
                updateInvoiceTable();
                updateDashboard();
                closeEditModal();
                showNotification('Factura actualizada correctamente', 'success');
            }
        }

        function closeEditModal() {
            document.getElementById('editInvoiceModal').classList.remove('active');
            currentEditInvoice = null;
        }

        // FUNCIÓN DE LIMPIAR TODOS LOS DATOS
        function clearAllData() {
            const confirmText = prompt('ADVERTENCIA: Esto eliminará TODOS los datos del sistema.\n\nPara confirmar, escriba "ELIMINAR TODO":');
            
            if (confirmText === 'ELIMINAR TODO') {
                const doubleConfirm = confirm('¿Está COMPLETAMENTE seguro?\n\nEsta acción NO se puede deshacer.');
                
                if (doubleConfirm) {
                    suppliers = [];
                    invoices = [];
                    payments = [];
                    
                    // Limpiar localStorage
                    localStorage.removeItem('suppliers');
                    localStorage.removeItem('invoices');
                    localStorage.removeItem('payments');
                    
                    updateAll();
                    showNotification('Todos los datos han sido eliminados', 'danger');
                }
            } else if (confirmText !== null) {
                showNotification('Texto de confirmación incorrecto. Operación cancelada.', 'warning');
            }
        }

        // FUNCIÓN DE ORDENAMIENTO DE FACTURAS
        function sortInvoices() {
            const sortBy = document.getElementById('sortInvoices').value;
            if (!sortBy) return;

            let sortedInvoices = [...invoices];

            switch (sortBy) {
                case 'dueDate':
                    sortedInvoices.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                    break;
                case 'dueDateDesc':
                    sortedInvoices.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
                    break;
                case 'amount':
                    sortedInvoices.sort((a, b) => a.amount - b.amount);
                    break;
                case 'amountDesc':
                    sortedInvoices.sort((a, b) => b.amount - a.amount);
                    break;
            }

            // Actualizar tabla con orden personalizado
            updateInvoiceTableSorted(sortedInvoices);
            showNotification('Facturas ordenadas correctamente', 'info');
        }

        function updateInvoiceTableSorted(sortedInvoices) {
            const tbody = document.getElementById('invoiceTableBody');
            tbody.innerHTML = '';

            sortedInvoices.forEach(function(invoice) {
                const today = new Date();
                const dueDate = new Date(invoice.dueDate);
                let statusClass = 'status-pending';
                let statusText = 'Pendiente';

                if (invoice.status === 'paid') {
                    statusClass = 'status-paid';
                    statusText = 'Pagado';
                } else if (dueDate < today) {
                    statusClass = 'status-overdue';
                    statusText = 'Vencido';
                }

                const row = tbody.insertRow();
                row.innerHTML = '<td><strong>' + invoice.invoiceNumber + '</strong></td>' +
                               '<td>' + invoice.supplierName + '</td>' +
                               '<td style="font-weight: bold; color: var(--primary);">' + formatCurrency(invoice.amount) + '</td>' +
                               '<td>' + formatDate(invoice.dueDate) + '</td>' +
                               '<td>' + (invoice.costCenter || 'N/A') + '</td>' +
                               '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>' +
                               '<td>' +
                               '<button class="btn btn-warning" onclick="editInvoice(' + invoice.id + ')" style="margin-right: 5px;">✏️ Editar</button>' +
                               (invoice.status === 'pending' ? '<button class="btn btn-success" onclick="payInvoice(' + invoice.id + ')">💳 Pagar</button>' : '') +
                               '<button class="btn btn-danger" onclick="deleteInvoice(' + invoice.id + ')">🗑</button>' +
                               '</td>';
            });
        }

        // SISTEMA DE ALERTAS Y NOTIFICACIONES
        function checkPendingInvoices() {
            const today = new Date();
            const alertDays = config.email.days || 7;
            const whatsappDays = parseInt(localStorage.getItem('whatsappDays') || '3');
            
            // Facturas que vencen pronto
            const soonToDue = invoices.filter(function(invoice) {
                if (invoice.status !== 'pending') return false;
                
                const dueDate = new Date(invoice.dueDate);
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                return daysDiff >= 0 && daysDiff <= Math.max(alertDays, whatsappDays);
            });

            // Facturas ya vencidas
            const overdue = invoices.filter(function(invoice) {
                if (invoice.status !== 'pending') return false;
                
                const dueDate = new Date(invoice.dueDate);
                return dueDate < today;
            });

            let message = `📊 Reporte de Vencimientos:\n\n`;
            message += `🔸 Facturas por vencer (${Math.max(alertDays, whatsappDays)} días): ${soonToDue.length}\n`;
            message += `🔴 Facturas vencidas: ${overdue.length}\n\n`;

            if (soonToDue.length > 0) {
                message += `⏰ PRÓXIMOS VENCIMIENTOS:\n`;
                soonToDue.forEach(function(invoice) {
                    const dueDate = new Date(invoice.dueDate);
                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    message += `• ${invoice.invoiceNumber} - ${invoice.supplierName} - ${formatCurrency(invoice.amount)} - ${daysDiff} día(s)\n`;
                });
                message += `\n`;
            }

            if (overdue.length > 0) {
                message += `🚨 FACTURAS VENCIDAS:\n`;
                overdue.forEach(function(invoice) {
                    const dueDate = new Date(invoice.dueDate);
                    const daysPast = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                    message += `• ${invoice.invoiceNumber} - ${invoice.supplierName} - ${formatCurrency(invoice.amount)} - ${daysPast} día(s) vencida\n`;
                });
            }

            alert(message);

            // Enviar alertas automáticamente
            if (soonToDue.length > 0 || overdue.length > 0) {
                sendEmailAlert(soonToDue, overdue);
                sendWhatsAppAlert(soonToDue, overdue);
            } else {
                showNotification('No hay facturas próximas a vencer', 'success');
            }
        }

        function sendEmailAlert(soonToDue, overdue) {
            const emailAddress = config.email.address;
            if (!emailAddress) {
                showNotification('Configure email para recibir alertas', 'warning');
                return;
            }

            let subject = 'Alerta ERP: Facturas Pendientes de Pago';
            let body = `Estimado/a,\n\nEste es un resumen de las facturas que requieren su atención:\n\n`;

            if (overdue.length > 0) {
                body += `🚨 FACTURAS VENCIDAS (${overdue.length}):\n`;
                overdue.forEach(function(invoice) {
                    const daysPast = Math.ceil((new Date() - new Date(invoice.dueDate)) / (1000 * 60 * 60 * 24));
                    body += `• Factura: ${invoice.invoiceNumber}\n`;
                    body += `  Proveedor: ${invoice.supplierName}\n`;
                    body += `  Monto: ${formatCurrency(invoice.amount)}\n`;
                    body += `  Vencida hace: ${daysPast} días\n\n`;
                });
            }

            if (soonToDue.length > 0) {
                body += `⏰ PRÓXIMOS VENCIMIENTOS (${soonToDue.length}):\n`;
                soonToDue.forEach(function(invoice) {
                    const daysDiff = Math.ceil((new Date(invoice.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    body += `• Factura: ${invoice.invoiceNumber}\n`;
                    body += `  Proveedor: ${invoice.supplierName}\n`;
                    body += `  Monto: ${formatCurrency(invoice.amount)}\n`;
                    body += `  Vence en: ${daysDiff} días\n\n`;
                });
            }

            body += `\nSaludos,\nSistema ERP Empresarial`;

            // Crear enlace mailto
            const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Abrir cliente de correo
            window.open(mailtoLink, '_blank');
            showNotification('Correo de alerta preparado y enviado a cliente de email', 'success');
        }

        function sendWhatsAppAlert(soonToDue, overdue) {
            const whatsappNumber = localStorage.getItem('whatsappNumber');
            if (!whatsappNumber) {
                showNotification('Configure número de WhatsApp para alertas', 'warning');
                return;
            }

            let message = `🏢 *ALERTA ERP - FACTURAS PENDIENTES*\n\n`;

            if (overdue.length > 0) {
                message += `🚨 *FACTURAS VENCIDAS (${overdue.length}):*\n`;
                overdue.forEach(function(invoice) {
                    const daysPast = Math.ceil((new Date() - new Date(invoice.dueDate)) / (1000 * 60 * 60 * 24));
                    message += `• ${invoice.invoiceNumber} - ${invoice.supplierName}\n`;
                    message += `  ${formatCurrency(invoice.amount)} - Vencida hace ${daysPast} días\n\n`;
                });
            }

            if (soonToDue.length > 0) {
                message += `⏰ *PRÓXIMOS VENCIMIENTOS (${soonToDue.length}):*\n`;
                soonToDue.forEach(function(invoice) {
                    const daysDiff = Math.ceil((new Date(invoice.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    message += `• ${invoice.invoiceNumber} - ${invoice.supplierName}\n`;
                    message += `  ${formatCurrency(invoice.amount)} - Vence en ${daysDiff} días\n\n`;
                });
            }

            message += `📱 Enviado desde Sistema ERP`;

            // Crear enlace de WhatsApp Web
            const cleanNumber = whatsappNumber.replace(/[^0-9]/g, '');
            const whatsappLink = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(message)}`;
            
            // Abrir WhatsApp Web
            window.open(whatsappLink, '_blank');
            showNotification('Alerta de WhatsApp enviada correctamente', 'success');
        }

        function saveWhatsAppSettings() {
            const number = document.getElementById('whatsappNumber').value;
            const token = document.getElementById('whatsappToken').value;
            const days = document.getElementById('whatsappDays').value;
            
            if (!number) {
                showNotification('Ingrese número de WhatsApp', 'warning');
                return;
            }
            
            localStorage.setItem('whatsappNumber', number);
            localStorage.setItem('whatsappToken', token);
            localStorage.setItem('whatsappDays', days);
            
            showNotification('Configuración de WhatsApp guardada', 'success');
        }

        function testWhatsAppAlert() {
            const whatsappNumber = localStorage.getItem('whatsappNumber');
            if (!whatsappNumber) {
                showNotification('Configure número de WhatsApp primero', 'warning');
                return;
            }

            const testMessage = `🧪 *PRUEBA DE ALERTA ERP*\n\n`;
            testMessage += `✅ El sistema de alertas por WhatsApp está funcionando correctamente.\n\n`;
            testMessage += `📱 Configurado para: ${whatsappNumber}\n`;
            testMessage += `📊 Total facturas: ${invoices.length}\n`;
            testMessage += `👥 Total proveedores: ${suppliers.length}\n\n`;
            testMessage += `🕒 ${new Date().toLocaleString('es-ES')}`;

            const cleanNumber = whatsappNumber.replace(/[^0-9]/g, '');
            const whatsappLink = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(testMessage)}`;
            
            window.open(whatsappLink, '_blank');
            showNotification('Prueba de WhatsApp enviada', 'success');
        }

        // FUNCIONES CRUD PROVEEDORES
        function addSupplier() {
            if (currentSupplier) {
                updateSupplier();
                return;
            }

            const supplier = {
                id: Date.now(),
                name: document.getElementById('supplierName').value,
                ruc: document.getElementById('supplierRuc').value,
                email: document.getElementById('supplierEmail').value,
                phone: document.getElementById('supplierPhone').value || '',
                address: document.getElementById('supplierAddress').value || '',
                category: document.getElementById('supplierCategory').value,
                createdAt: new Date().toISOString()
            };

            if (!supplier.name || !supplier.ruc || !supplier.email) {
                showNotification('Complete los campos obligatorios', 'warning');
                return;
            }

            suppliers.push(supplier);
            saveData();
            updateSupplierTable();
            updateSupplierSelect();
            clearSupplierForm();
            showNotification('Proveedor agregado correctamente', 'success');
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;

            currentSupplier = supplier;
            
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierRuc').value = supplier.ruc;
            document.getElementById('supplierEmail').value = supplier.email;
            document.getElementById('supplierPhone').value = supplier.phone || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierCategory').value = supplier.category;
            
            const submitBtn = document.getElementById('supplierSubmitBtn');
            submitBtn.textContent = '✏️ Actualizar Proveedor';
            submitBtn.className = 'btn btn-warning';
            
            showNotification('Modo edición activado', 'info');
        }

        function updateSupplier() {
            if (!currentSupplier) return;

            const updatedData = {
                name: document.getElementById('supplierName').value,
                ruc: document.getElementById('supplierRuc').value,
                email: document.getElementById('supplierEmail').value,
                phone: document.getElementById('supplierPhone').value || '',
                address: document.getElementById('supplierAddress').value || '',
                category: document.getElementById('supplierCategory').value
            };

            if (!updatedData.name || !updatedData.ruc || !updatedData.email) {
                showNotification('Complete los campos obligatorios', 'warning');
                return;
            }

            const index = suppliers.findIndex(s => s.id === currentSupplier.id);
            if (index !== -1) {
                suppliers[index] = { ...suppliers[index], ...updatedData };
                saveData();
                updateSupplierTable();
                updateSupplierSelect();
                clearSupplierForm();
                showNotification('Proveedor actualizado correctamente', 'success');
            }
        }

        function clearSupplierForm() {
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierRuc').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierAddress').value = '';
            
            const submitBtn = document.getElementById('supplierSubmitBtn');
            submitBtn.textContent = '➕ Agregar Proveedor';
            submitBtn.className = 'btn btn-primary';
            
            currentSupplier = null;
        }

        function deleteSupplier(id) {
            if (confirm('¿Eliminar este proveedor?')) {
                suppliers = suppliers.filter(function(s) { return s.id !== id; });
                saveData();
                updateSupplierTable();
                updateSupplierSelect();
                showNotification('Proveedor eliminado', 'success');
            }
        }

        // FUNCIONES CRUD FACTURAS
        function addInvoice() {
            const selectEl = document.getElementById('supplierSelect');
            const invoice = {
                id: Date.now(),
                supplierId: selectEl.value,
                supplierName: selectEl.options[selectEl.selectedIndex].text,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                amount: parseInt(document.getElementById('amount').value),
                dueDate: document.getElementById('dueDate').value,
                costCenter: document.getElementById('costCenter').value || '',
                description: document.getElementById('description').value || '',
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            if (!invoice.supplierId || !invoice.invoiceNumber || !invoice.amount || !invoice.dueDate) {
                showNotification('Complete todos los campos obligatorios', 'warning');
                return;
            }

            invoices.push(invoice);
            saveData();
            updateInvoiceTable();
            clearInvoiceForm();
            showNotification('Factura agregada correctamente', 'success');
        }

        function deleteInvoice(id) {
            if (confirm('¿Eliminar esta factura?')) {
                invoices = invoices.filter(function(i) { return i.id !== id; });
                saveData();
                updateInvoiceTable();
                updateDashboard();
                showNotification('Factura eliminada', 'success');
            }
        }

        function payInvoice(id) {
            currentInvoice = invoices.find(function(i) { return i.id === id; });
            if (currentInvoice) {
                currentPayment = null;
                document.getElementById('paymentModalTitle').textContent = '💳 Registrar Pago';
                document.getElementById('paymentConfirmBtn').textContent = '✅ Confirmar Pago';
                document.getElementById('paymentConfirmBtn').className = 'btn btn-success';
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('paymentMethod').value = 'transferencia';
                document.getElementById('paymentReference').value = '';
                document.getElementById('paymentNotes').value = '';
                document.getElementById('paymentModal').classList.add('active');
            }
        }

        function editPayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;

            currentPayment = payment;
            currentInvoice = null;
            
            document.getElementById('paymentModalTitle').textContent = '✏️ Editar Pago';
            document.getElementById('paymentConfirmBtn').textContent = '💾 Actualizar Pago';
            document.getElementById('paymentConfirmBtn').className = 'btn btn-warning';
            
            document.getElementById('paymentDate').value = payment.paymentDate;
            document.getElementById('paymentMethod').value = payment.method || 'transferencia';
            document.getElementById('paymentReference').value = payment.reference || '';
            document.getElementById('paymentNotes').value = payment.notes || '';
            
            document.getElementById('paymentModal').classList.add('active');
            showNotification('Modo edición de pago activado', 'info');
        }

        function deletePayment(id) {
            if (!confirm('¿Eliminar este pago? Esta acción cambiará el estado de la factura a pendiente.')) return;

            const payment = payments.find(p => p.id === id);
            if (payment) {
                // Cambiar estado de factura a pendiente
                const invoice = invoices.find(i => i.id === payment.invoiceId);
                if (invoice) {
                    invoice.status = 'pending';
                    delete invoice.paymentDate;
                }
            }

            payments = payments.filter(p => p.id !== id);
            saveData();
            updatePaymentTable();
            updateInvoiceTable();
            updateDashboard();
            showNotification('Pago eliminado y factura marcada como pendiente', 'success');
        }

        function confirmPayment() {
            const paymentDate = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('paymentReference').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!paymentDate) {
                showNotification('Ingrese la fecha de pago', 'warning');
                return;
            }

            if (currentPayment) {
                // Actualizar pago existente
                const index = payments.findIndex(p => p.id === currentPayment.id);
                if (index !== -1) {
                    payments[index].paymentDate = paymentDate;
                    payments[index].method = method;
                    payments[index].reference = reference;
                    payments[index].notes = notes;
                    payments[index].updatedAt = new Date().toISOString();
                }
                showNotification('Pago actualizado correctamente', 'success');
            } else if (currentInvoice) {
                // Crear nuevo pago
                const invoiceIndex = invoices.findIndex(function(i) { return i.id === currentInvoice.id; });
                if (invoiceIndex !== -1) {
                    invoices[invoiceIndex].status = 'paid';
                    invoices[invoiceIndex].paymentDate = paymentDate;
                }

                const payment = {
                    id: Date.now(),
                    invoiceId: currentInvoice.id,
                    invoiceNumber: currentInvoice.invoiceNumber,
                    supplierName: currentInvoice.supplierName,
                    amount: currentInvoice.amount,
                    paymentDate: paymentDate,
                    method: method,
                    reference: reference || '',
                    notes: notes || '',
                    processedBy: 'Usuario',
                    processedAt: new Date().toISOString()
                };

                payments.push(payment);
                showNotification('Pago registrado correctamente', 'success');
            }

            saveData();
            closeModal();
            updateInvoiceTable();
            updatePaymentTable();
            updateDashboard();
        }

        function closeModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentDate').value = '';
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNotes').value = '';
            currentInvoice = null;
        }

        // FUNCIONES DE ACTUALIZACIÓN
        function updateSupplierTable() {
            const tbody = document.getElementById('supplierTableBody');
            tbody.innerHTML = '';

            suppliers.forEach(function(supplier) {
                const row = tbody.insertRow();
                row.innerHTML = '<td><strong>' + supplier.name + '</strong></td>' +
                               '<td>' + supplier.ruc + '</td>' +
                               '<td>' + supplier.email + '</td>' +
                               '<td>' + (supplier.phone || 'N/A') + '</td>' +
                               '<td><span class="status-badge" style="background: #e0f2fe; color: #0277bd;">' + supplier.category + '</span></td>' +
                               '<td>' +
                               '<button class="btn btn-warning" onclick="editSupplier(' + supplier.id + ')" style="margin-right: 5px;">✏️ Editar</button>' +
                               '<button class="btn btn-danger" onclick="deleteSupplier(' + supplier.id + ')">🗑 Eliminar</button>' +
                               '</td>';
            });
        }

        function updateSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            select.innerHTML = '<option value="">Seleccionar proveedor</option>';

            suppliers.forEach(function(supplier) {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
        }

        function updateInvoiceTable() {
            const tbody = document.getElementById('invoiceTableBody');
            tbody.innerHTML = '';

            invoices.forEach(function(invoice) {
                const today = new Date();
                const dueDate = new Date(invoice.dueDate);
                let statusClass = 'status-pending';
                let statusText = 'Pendiente';

                if (invoice.status === 'paid') {
                    statusClass = 'status-paid';
                    statusText = 'Pagado';
                } else if (dueDate < today) {
                    statusClass = 'status-overdue';
                    statusText = 'Vencido';
                }

                const row = tbody.insertRow();
                row.innerHTML = '<td><strong>' + invoice.invoiceNumber + '</strong></td>' +
                               '<td>' + invoice.supplierName + '</td>' +
                               '<td style="font-weight: bold; color: var(--primary);">' + formatCurrency(invoice.amount) + '</td>' +
                               '<td>' + formatDate(invoice.dueDate) + '</td>' +
                               '<td>' + (invoice.costCenter || 'N/A') + '</td>' +
                               '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>' +
                               '<td>' +
                               '<button class="btn btn-warning" onclick="editInvoice(' + invoice.id + ')" style="margin-right: 5px;">✏️ Editar</button>' +
                               (invoice.status === 'pending' ? '<button class="btn btn-success" onclick="payInvoice(' + invoice.id + ')">💳 Pagar</button>' : '') +
                               '<button class="btn btn-danger" onclick="deleteInvoice(' + invoice.id + ')">🗑</button>' +
                               '</td>';
            });
        }

        function updatePaymentTable() {
            const tbody = document.getElementById('paymentTableBody');
            tbody.innerHTML = '';

            payments.forEach(function(payment) {
                const row = tbody.insertRow();
                row.innerHTML = '<td><strong>' + formatDate(payment.paymentDate) + '</strong></td>' +
                               '<td>' + payment.invoiceNumber + '</td>' +
                               '<td>' + payment.supplierName + '</td>' +
                               '<td style="font-weight: bold; color: var(--success);">' + formatCurrency(payment.amount) + '</td>' +
                               '<td>' + (payment.method || 'N/A') + '</td>' +
                               '<td>' + payment.processedBy + '</td>' +
                               '<td>' +
                               '<button class="btn btn-warning" onclick="editPayment(' + payment.id + ')" style="margin-right: 5px;">✏️ Editar</button>' +
                               '<button class="btn btn-danger" onclick="deletePayment(' + payment.id + ')">🗑 Eliminar</button>' +
                               '</td>';
            });
        }

        function updateDashboard() {
            const totalPending = invoices.filter(function(i) { return i.status === 'pending'; })
                .reduce(function(sum, i) { return sum + i.amount; }, 0);
            
            const today = new Date();
            const overdueCount = invoices.filter(function(i) { 
                return i.status === 'pending' && new Date(i.dueDate) < today; 
            }).length;

            document.getElementById('totalPending').textContent = formatCurrency(totalPending);
            document.getElementById('overdueCount').textContent = overdueCount;
            document.getElementById('supplierCount').textContent = suppliers.length;
            document.getElementById('paymentCount').textContent = payments.length;

            const statusAlert = document.getElementById('statusAlert');
            if (overdueCount > 0) {
                statusAlert.className = 'alert alert-danger';
                statusAlert.innerHTML = '🚨 <strong>Atención:</strong> Tienes ' + overdueCount + ' factura(s) vencida(s).';
            } else {
                statusAlert.className = 'alert alert-success';
                statusAlert.innerHTML = '✅ <strong>Excelente:</strong> No hay facturas vencidas.';
            }
        }

        // FUNCIONES DE UTILIDAD
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('es-ES');
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '$0';
            return '$' + Math.round(amount).toLocaleString('es-CL');
        }

        // FUNCIONES DE ALMACENAMIENTO HÍBRIDAS (Local + Firebase)
        function saveData() {
            if (isFirebaseMode && db) {
                return saveDataFirebase();
            } else {
                return saveDataLocal();
            }
        }

        function saveDataLocal() {
            try {
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('invoices', JSON.stringify(invoices));
                localStorage.setItem('payments', JSON.stringify(payments));
                localStorage.setItem('products', JSON.stringify(products));
                return Promise.resolve();
            } catch (error) {
                if (error.name === 'QuotaExceededError' || error.message.includes('quota')) {
                    handleStorageQuotaExceeded();
                } else {
                    showNotification('Error guardando datos localmente: ' + error.message, 'danger');
                }
                return Promise.reject(error);
            }
        }

        async function saveDataFirebase() {
            if (!db) {
                showNotification('Firebase no disponible, guardando localmente', 'warning');
                return saveDataLocal();
            }

            try {
                // Usar batch para operaciones atómicas
                const batch = db.batch();
                
                // Actualizar proveedores modificados
                if (suppliers.length > 0) {
                    const suppliersRef = db.collection('suppliers');
                    suppliers.forEach(supplier => {
                        const docRef = suppliersRef.doc(supplier.id.toString());
                        batch.set(docRef, supplier, { merge: true });
                    });
                }

                // Actualizar facturas modificadas
                if (invoices.length > 0) {
                    const invoicesRef = db.collection('invoices');
                    invoices.forEach(invoice => {
                        const docRef = invoicesRef.doc(invoice.id.toString());
                        batch.set(docRef, invoice, { merge: true });
                    });
                }

                // Actualizar pagos modificados
                if (payments.length > 0) {
                    const paymentsRef = db.collection('payments');
                    payments.forEach(payment => {
                        const docRef = paymentsRef.doc(payment.id.toString());
                        batch.set(docRef, payment, { merge: true });
                    });
                }

                // Actualizar productos modificados
                if (products.length > 0) {
                    const productsRef = db.collection('products');
                    products.forEach(product => {
                        const docRef = productsRef.doc(product.id.toString());
                        batch.set(docRef, product, { merge: true });
                    });
                }

                await batch.commit();
                
                // También guardar local como respaldo
                saveDataLocal();
                
                updateSyncStatus('firebase', 'Sincronizado con Firebase');
                
            } catch (error) {
                updateSyncStatus('error', 'Error de sincronización');
                showNotification('Error guardando en Firebase, usando almacén local', 'warning');
                return saveDataLocal();
            }
        }

        async function loadDataFirebase() {
            if (!db) {
                return loadDataLocal();
            }

            try {
                updateSyncStatus('firebase', 'Cargando desde Firebase...');

                // Cargar proveedores
                const suppliersSnapshot = await db.collection('suppliers').get();
                const firebaseSuppliers = [];
                suppliersSnapshot.forEach(doc => {
                    firebaseSuppliers.push({ ...doc.data(), id: doc.data().id || doc.id });
                });

                // Cargar facturas
                const invoicesSnapshot = await db.collection('invoices').get();
                const firebaseInvoices = [];
                invoicesSnapshot.forEach(doc => {
                    firebaseInvoices.push({ ...doc.data(), id: doc.data().id || doc.id });
                });

                // Cargar pagos
                const paymentsSnapshot = await db.collection('payments').get();
                const firebasePayments = [];
                paymentsSnapshot.forEach(doc => {
                    firebasePayments.push({ ...doc.data(), id: doc.data().id || doc.id });
                });

                // Cargar productos
                const productsSnapshot = await db.collection('products').get();
                const firebaseProducts = [];
                productsSnapshot.forEach(doc => {
                    firebaseProducts.push({ ...doc.data(), id: doc.data().id || doc.id });
                });

                // Actualizar variables globales
                suppliers = firebaseSuppliers;
                invoices = firebaseInvoices;
                payments = firebasePayments;
                products = firebaseProducts;

                // Guardar como respaldo local
                saveDataLocal();

                updateSyncStatus('firebase', 'Datos cargados desde Firebase');
                showNotification(`Datos cargados: ${suppliers.length} proveedores, ${invoices.length} facturas, ${payments.length} pagos, ${products.length} productos`, 'success');

                return { suppliers, invoices, payments, products };

            } catch (error) {
                updateSyncStatus('error', 'Error cargando de Firebase');
                showNotification('Error cargando Firebase, usando datos locales', 'warning');
                return loadDataLocal();
            }
        }

        function loadDataLocal() {
            try {
                suppliers = JSON.parse(localStorage.getItem('suppliers') || '[]');
                invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                payments = JSON.parse(localStorage.getItem('payments') || '[]');
                products = JSON.parse(localStorage.getItem('products') || '[]');
                
                updateSyncStatus('local', 'Datos cargados localmente');
                return { suppliers, invoices, payments, products };
            } catch (error) {
                showNotification('Error cargando datos locales: ' + error.message, 'danger');
                return { suppliers: [], invoices: [], payments: [], products: [] };
            }
        }

        async function deleteFromFirebase(collection, id) {
            if (!db || !isFirebaseMode) {
                return Promise.resolve();
            }

            try {
                await db.collection(collection).doc(id.toString()).delete();
            } catch (error) {
                console.warn('Error eliminando de Firebase:', error);
                showNotification('Error eliminando de la nube, manteniendo cambio local', 'warning');
            }
        }

        // FUNCIONES CRUD MODIFICADAS PARA FIREBASE

        function addSupplier() {
            if (currentSupplier) {
                updateSupplier();
                return;
            }

            const supplier = {
                id: Date.now(),
                name: document.getElementById('supplierName').value,
                ruc: document.getElementById('supplierRuc').value,
                email: document.getElementById('supplierEmail').value,
                phone: document.getElementById('supplierPhone').value || '',
                address: document.getElementById('supplierAddress').value || '',
                category: document.getElementById('supplierCategory').value,
                createdAt: new Date().toISOString()
            };

            if (!supplier.name || !supplier.ruc || !supplier.email) {
                showNotification('Complete los campos obligatorios', 'warning');
                return;
            }

            suppliers.push(supplier);
            saveData().then(() => {
                updateSupplierTable();
                updateSupplierSelect();
                clearSupplierForm();
                showNotification('Proveedor agregado correctamente', 'success');
            }).catch((error) => {
                showNotification('Error guardando proveedor', 'danger');
            });
        }

        function deleteSupplier(id) {
            if (confirm('¿Eliminar este proveedor?')) {
                suppliers = suppliers.filter(function(s) { return s.id !== id; });
                
                // Eliminar de Firebase si está en modo nube
                deleteFromFirebase('suppliers', id);
                
                saveData().then(() => {
                    updateSupplierTable();
                    updateSupplierSelect();
                    showNotification('Proveedor eliminado', 'success');
                });
            }
        }

        function addInvoice() {
            const selectEl = document.getElementById('supplierSelect');
            const invoice = {
                id: Date.now(),
                supplierId: selectEl.value,
                supplierName: selectEl.options[selectEl.selectedIndex].text,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                amount: parseInt(document.getElementById('amount').value),
                dueDate: document.getElementById('dueDate').value,
                costCenter: document.getElementById('costCenter').value || '',
                description: document.getElementById('description').value || '',
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            if (!invoice.supplierId || !invoice.invoiceNumber || !invoice.amount || !invoice.dueDate) {
                showNotification('Complete todos los campos obligatorios', 'warning');
                return;
            }

            invoices.push(invoice);
            saveData().then(() => {
                updateInvoiceTable();
                clearInvoiceForm();
                showNotification('Factura agregada correctamente', 'success');
            });
        }

        function deleteInvoice(id) {
            if (confirm('¿Eliminar esta factura?')) {
                invoices = invoices.filter(function(i) { return i.id !== id; });
                
                // Eliminar de Firebase si está en modo nube
                deleteFromFirebase('invoices', id);
                
                saveData().then(() => {
                    updateInvoiceTable();
                    updateDashboard();
                    showNotification('Factura eliminada', 'success');
                });
            }
        }

        function confirmPayment() {
            const paymentDate = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('paymentReference').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!paymentDate) {
                showNotification('Ingrese la fecha de pago', 'warning');
                return;
            }

            if (currentPayment) {
                // Actualizar pago existente
                const index = payments.findIndex(p => p.id === currentPayment.id);
                if (index !== -1) {
                    payments[index].paymentDate = paymentDate;
                    payments[index].method = method;
                    payments[index].reference = reference;
                    payments[index].notes = notes;
                    payments[index].updatedAt = new Date().toISOString();
                }
                showNotification('Pago actualizado correctamente', 'success');
            } else if (currentInvoice) {
                // Crear nuevo pago
                const invoiceIndex = invoices.findIndex(function(i) { return i.id === currentInvoice.id; });
                if (invoiceIndex !== -1) {
                    invoices[invoiceIndex].status = 'paid';
                    invoices[invoiceIndex].paymentDate = paymentDate;
                }

                const payment = {
                    id: Date.now(),
                    invoiceId: currentInvoice.id,
                    invoiceNumber: currentInvoice.invoiceNumber,
                    supplierName: currentInvoice.supplierName,
                    amount: currentInvoice.amount,
                    paymentDate: paymentDate,
                    method: method,
                    reference: reference || '',
                    notes: notes || '',
                    processedBy: 'Usuario',
                    processedAt: new Date().toISOString()
                };

                payments.push(payment);
                showNotification('Pago registrado correctamente', 'success');
            }

            saveData().then(() => {
                closeModal();
                updateInvoiceTable();
                updatePaymentTable();
                updateDashboard();
            });
        }

        function handleStorageQuotaExceeded() {
            showNotification('Almacenamiento lleno - Iniciando limpieza automática...', 'warning');
            
            // Crear respaldo automático antes de limpiar
            createEmergencyBackup();
            
            // Limpiar datos antiguos y optimizar
            optimizeStorage();
            
            // Intentar guardar nuevamente
            try {
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('invoices', JSON.stringify(invoices));
                localStorage.setItem('payments', JSON.stringify(payments));
                showNotification('Datos optimizados y guardados correctamente', 'success');
            } catch (error) {
                // Si aún hay problemas, usar almacenamiento comprimido
                useCompressedStorage();
            }
        }

        function optimizeStorage() {
            // Limpiar registros antiguos (más de 2 años)
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            
            const originalInvoiceCount = invoices.length;
            const originalPaymentCount = payments.length;
            
            // Mantener solo facturas de los últimos 2 años
            invoices = invoices.filter(invoice => {
                const createdDate = new Date(invoice.createdAt);
                return createdDate > twoYearsAgo;
            });
            
            // Mantener solo pagos de los últimos 2 años
            payments = payments.filter(payment => {
                const createdDate = new Date(payment.processedAt);
                return createdDate > twoYearsAgo;
            });
            
            // Limpiar proveedores sin facturas asociadas
            const usedSupplierIds = [...new Set(invoices.map(i => i.supplierId))];
            const originalSupplierCount = suppliers.length;
            suppliers = suppliers.filter(supplier => 
                usedSupplierIds.includes(supplier.id) || 
                new Date(supplier.createdAt) > twoYearsAgo
            );
            
            // Limpiar configuraciones innecesarias del localStorage
            const keysToKeep = ['suppliers', 'invoices', 'payments', 'alertEmail', 'alertDays', 'whatsappNumber', 'whatsappDays'];
            Object.keys(localStorage).forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            const cleanedInvoices = originalInvoiceCount - invoices.length;
            const cleanedPayments = originalPaymentCount - payments.length;
            const cleanedSuppliers = originalSupplierCount - suppliers.length;
            
            showNotification(`Limpieza completada: ${cleanedInvoices} facturas, ${cleanedPayments} pagos y ${cleanedSuppliers} proveedores antiguos eliminados`, 'info');
        }

        function createEmergencyBackup() {
            try {
                const backup = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    reason: 'storage_quota_exceeded',
                    data: { suppliers: suppliers, invoices: invoices, payments: payments }
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ERP-Respaldo-Emergencia-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('Respaldo de emergencia creado automáticamente', 'info');
            } catch (error) {
                console.error('Error creando respaldo de emergencia:', error);
            }
        }

        function useCompressedStorage() {
            try {
                // Comprimir datos eliminando campos innecesarios para el almacenamiento
                const compressedSuppliers = suppliers.map(s => ({
                    id: s.id,
                    name: s.name,
                    ruc: s.ruc,
                    email: s.email,
                    category: s.category
                    // Omitir phone, address, createdAt para ahorrar espacio
                }));
                
                const compressedInvoices = invoices.map(i => ({
                    id: i.id,
                    supplierId: i.supplierId,
                    supplierName: i.supplierName,
                    invoiceNumber: i.invoiceNumber,
                    amount: i.amount,
                    dueDate: i.dueDate,
                    status: i.status
                    // Omitir costCenter, description, createdAt para ahorrar espacio
                }));
                
                const compressedPayments = payments.map(p => ({
                    id: p.id,
                    invoiceId: p.invoiceId,
                    amount: p.amount,
                    paymentDate: p.paymentDate,
                    method: p.method
                    // Omitir campos menos críticos
                }));
                
                localStorage.setItem('suppliers', JSON.stringify(compressedSuppliers));
                localStorage.setItem('invoices', JSON.stringify(compressedInvoices));
                localStorage.setItem('payments', JSON.stringify(compressedPayments));
                localStorage.setItem('dataCompressed', 'true');
                
                showNotification('Datos comprimidos y guardados en modo reducido', 'warning');
            } catch (error) {
                showNotification('Error crítico de almacenamiento - Use respaldo manual', 'danger');
                // Como último recurso, sugerir al usuario que descargue los datos
                createBackup();
            }
        }

        function checkStorageUsage() {
            try {
                // Estimar uso del localStorage
                let totalStorage = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalStorage += localStorage[key].length + key.length;
                    }
                }
                
                const storageMB = (totalStorage / (1024 * 1024)).toFixed(2);
                const maxStorage = 5; // Límite típico de 5MB
                const usagePercent = ((totalStorage / (maxStorage * 1024 * 1024)) * 100).toFixed(1);
                
                return {
                    used: storageMB,
                    percentage: usagePercent,
                    isNearLimit: usagePercent > 80
                };
            } catch (error) {
                return { used: 'N/A', percentage: 'N/A', isNearLimit: false };
            }
        }

        function updateStorageInfo() {
            const storageInfo = checkStorageUsage();
            
            document.getElementById('storageUsage').textContent = `${storageInfo.used} MB (${storageInfo.percentage}%)`;
            document.getElementById('storageBar').style.width = `${Math.min(storageInfo.percentage, 100)}%`;
            
            // Cambiar color de la barra según el uso
            const bar = document.getElementById('storageBar');
            if (storageInfo.percentage < 60) {
                bar.style.background = '#10b981'; // Verde
            } else if (storageInfo.percentage < 80) {
                bar.style.background = '#f59e0b'; // Amarillo
            } else {
                bar.style.background = '#ef4444'; // Rojo
            }
            
            // Actualizar estadísticas de datos
            document.getElementById('statsSuppliers').textContent = suppliers.length;
            document.getElementById('statsInvoices').textContent = invoices.length;
            document.getElementById('statsPay').textContent = payments.length;
            
            // Actualizar botón de optimización
            const optimizeBtn = document.getElementById('optimizeBtn');
            if (storageInfo.isNearLimit) {
                optimizeBtn.textContent = '🔥 Limpiar URGENTE';
                optimizeBtn.className = 'btn btn-danger';
            } else {
                optimizeBtn.textContent = '🧹 Limpiar Antiguos';
                optimizeBtn.className = 'btn btn-warning';
            }
            
            if (storageInfo.isNearLimit) {
                showNotification('Advertencia: Almacenamiento cerca del límite', 'warning');
            }
        }

        function forceStorageCleanup() {
            if (!confirm('¿Realizar limpieza forzada? Esto eliminará datos antiguos y configuraciones innecesarias.')) return;
            
            showNotification('Iniciando limpieza forzada...', 'info');
            
            // Crear respaldo antes de limpiar
            createEmergencyBackup();
            
            // Limpieza más agresiva
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const originalCounts = {
                suppliers: suppliers.length,
                invoices: invoices.length,
                payments: payments.length
            };
            
            // Mantener solo facturas de los últimos 6 meses
            invoices = invoices.filter(invoice => {
                const createdDate = new Date(invoice.createdAt);
                return createdDate > sixMonthsAgo || invoice.status === 'pending';
            });
            
            // Mantener solo pagos de los últimos 6 meses
            payments = payments.filter(payment => {
                const createdDate = new Date(payment.processedAt);
                return createdDate > sixMonthsAgo;
            });
            
            // Limpiar proveedores sin facturas recientes
            const recentSupplierIds = [...new Set(invoices.map(i => i.supplierId))];
            suppliers = suppliers.filter(supplier => 
                recentSupplierIds.includes(supplier.id) || 
                new Date(supplier.createdAt) > sixMonthsAgo
            );
            
            // Limpiar completamente localStorage extra
            const essentialKeys = ['suppliers', 'invoices', 'payments', 'alertEmail', 'alertDays', 'whatsappNumber', 'whatsappDays'];
            Object.keys(localStorage).forEach(key => {
                if (!essentialKeys.includes(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            try {
                saveData();
                updateAll();
                updateStorageInfo();
                
                const cleaned = {
                    suppliers: originalCounts.suppliers - suppliers.length,
                    invoices: originalCounts.invoices - invoices.length,
                    payments: originalCounts.payments - payments.length
                };
                
                showNotification(`Limpieza forzada completada: ${cleaned.invoices} facturas, ${cleaned.payments} pagos y ${cleaned.suppliers} proveedores eliminados`, 'success');
            } catch (error) {
                showNotification('Error en limpieza forzada: ' + error.message, 'danger');
            }
        }

        function validateData() {
            showNotification('Validando integridad de datos...', 'info');
            
            let issues = [];
            let fixed = 0;
            
            // Validar proveedores
            suppliers.forEach((supplier, index) => {
                if (!supplier.id || !supplier.name || !supplier.ruc) {
                    issues.push(`Proveedor ${index + 1}: Datos incompletos`);
                }
                if (supplier.ruc && supplier.ruc.length < 3) {
                    issues.push(`Proveedor ${supplier.name}: RUT muy corto`);
                }
            });
            
            // Validar facturas
            invoices.forEach((invoice, index) => {
                if (!invoice.id || !invoice.invoiceNumber || !invoice.amount) {
                    issues.push(`Factura ${index + 1}: Datos críticos faltantes`);
                }
                if (invoice.amount && invoice.amount < 0) {
                    issues.push(`Factura ${invoice.invoiceNumber}: Monto negativo`);
                }
                if (invoice.dueDate && new Date(invoice.dueDate) < new Date('2020-01-01')) {
                    issues.push(`Factura ${invoice.invoiceNumber}: Fecha de vencimiento sospechosa`);
                }
            });
            
            // Validar pagos
            payments.forEach((payment, index) => {
                if (!payment.id || !payment.invoiceId || !payment.amount) {
                    issues.push(`Pago ${index + 1}: Datos críticos faltantes`);
                }
                if (payment.amount && payment.amount < 0) {
                    issues.push(`Pago ${payment.invoiceNumber || index + 1}: Monto negativo`);
                }
            });
            
            // Buscar duplicados
            const invoiceNumbers = {};
            invoices.forEach(invoice => {
                if (invoiceNumbers[invoice.invoiceNumber]) {
                    issues.push(`Factura duplicada: ${invoice.invoiceNumber}`);
                } else {
                    invoiceNumbers[invoice.invoiceNumber] = true;
                }
            });
            
            // Buscar referencias rotas
            invoices.forEach(invoice => {
                if (invoice.supplierId && !suppliers.find(s => s.id === invoice.supplierId)) {
                    issues.push(`Factura ${invoice.invoiceNumber}: Proveedor no encontrado`);
                }
            });
            
            payments.forEach(payment => {
                if (!invoices.find(i => i.id === payment.invoiceId)) {
                    issues.push(`Pago ${payment.invoiceNumber || 'sin número'}: Factura asociada no encontrada`);
                }
            });
            
            if (issues.length === 0) {
                showNotification('✅ Validación completada: No se encontraron problemas', 'success');
            } else {
                showNotification(`⚠️ Se encontraron ${issues.length} problema(s). Ver consola para detalles`, 'warning');
                console.warn('Problemas de validación encontrados:', issues);
            }
            
            // Mostrar resultados en modal (simplificado)
            alert(`Validación de Datos Completada:\n\n${issues.length === 0 ? '✅ Sin problemas encontrados' : '⚠️ Problemas encontrados: ' + issues.length + '\n\nVer consola del navegador para detalles completos'}`);
        }

        function repairData() {
            if (!confirm('¿Intentar reparar automáticamente los datos? Esto puede eliminar registros corruptos.')) return;
            
            showNotification('Reparando datos...', 'info');
            
            let repaired = 0;
            const originalCounts = {
                suppliers: suppliers.length,
                invoices: invoices.length,
                payments: payments.length
            };
            
            // Reparar proveedores
            suppliers = suppliers.filter(supplier => {
                if (!supplier.id || !supplier.name || !supplier.ruc) {
                    repaired++;
                    return false;
                }
                // Reparar datos faltantes
                if (!supplier.email) supplier.email = '';
                if (!supplier.phone) supplier.phone = '';
                if (!supplier.address) supplier.address = '';
                if (!supplier.category) supplier.category = 'reparado';
                if (!supplier.createdAt) supplier.createdAt = new Date().toISOString();
                return true;
            });
            
            // Reparar facturas
            invoices = invoices.filter(invoice => {
                if (!invoice.id || !invoice.invoiceNumber || !invoice.amount) {
                    repaired++;
                    return false;
                }
                // Reparar datos faltantes
                if (!invoice.supplierName) invoice.supplierName = 'Proveedor Desconocido';
                if (!invoice.dueDate) invoice.dueDate = new Date().toISOString().split('T')[0];
                if (!invoice.status) invoice.status = 'pending';
                if (!invoice.createdAt) invoice.createdAt = new Date().toISOString();
                if (!invoice.costCenter) invoice.costCenter = '';
                if (!invoice.description) invoice.description = '';
                // Corregir montos negativos
                if (invoice.amount < 0) {
                    invoice.amount = Math.abs(invoice.amount);
                    repaired++;
                }
                return true;
            });
            
            // Reparar pagos
            payments = payments.filter(payment => {
                if (!payment.id || !payment.invoiceId || !payment.amount) {
                    repaired++;
                    return false;
                }
                // Reparar datos faltantes
                if (!payment.paymentDate) payment.paymentDate = new Date().toISOString().split('T')[0];
                if (!payment.method) payment.method = 'transferencia';
                if (!payment.processedBy) payment.processedBy = 'Sistema';
                if (!payment.processedAt) payment.processedAt = new Date().toISOString();
                // Corregir montos negativos
                if (payment.amount < 0) {
                    payment.amount = Math.abs(payment.amount);
                    repaired++;
                }
                return true;
            });
            
            // Remover duplicados de facturas
            const seen = new Set();
            const originalInvoicesLength = invoices.length;
            invoices = invoices.filter(invoice => {
                if (seen.has(invoice.invoiceNumber)) {
                    repaired++;
                    return false;
                }
                seen.add(invoice.invoiceNumber);
                return true;
            });
            
            // Remover pagos huérfanos
            const validInvoiceIds = new Set(invoices.map(i => i.id));
            const originalPaymentsLength = payments.length;
            payments = payments.filter(payment => {
                if (!validInvoiceIds.has(payment.invoiceId)) {
                    repaired++;
                    return false;
                }
                return true;
            });
            
            try {
                saveData();
                updateAll();
                updateStorageInfo();
                
                const deletedCounts = {
                    suppliers: originalCounts.suppliers - suppliers.length,
                    invoices: originalCounts.invoices - invoices.length,
                    payments: originalCounts.payments - payments.length
                };
                
                showNotification(`Reparación completada: ${repaired} problemas corregidos, ${deletedCounts.suppliers + deletedCounts.invoices + deletedCounts.payments} registros eliminados`, 'success');
            } catch (error) {
                showNotification('Error durante reparación: ' + error.message, 'danger');
            }
        }

        function updateAll() {
            updateSupplierTable();
            updateSupplierSelect();
            updateInvoiceTable();
            updatePaymentTable();
            updateDashboard();
        }

        function clearInvoiceForm() {
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('costCenter').value = '';
            document.getElementById('description').value = '';
            setDefaultDate();
        }

        function setDefaultDate() {
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('dueDate').value = nextMonth.toISOString().split('T')[0];
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification alert-' + type;
            notification.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;">' +
                '<span>' + (type === 'success' ? '✅' : type === 'warning' ? '⚠️' : type === 'danger' ? '🚨' : 'ℹ️') + '</span>' +
                '<span>' + message + '</span>' +
                '</div>';
            document.body.appendChild(notification);
            
            setTimeout(function() { notification.classList.add('show'); }, 100);
            setTimeout(function() {
                notification.classList.remove('show');
                setTimeout(function() {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, 4000);
        }

        function searchPayments() {
            const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            const rows = document.getElementById('paymentTableBody').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const text = rows[i].textContent.toLowerCase();
                rows[i].style.display = text.includes(searchTerm) ? '' : 'none';
            }
        }

        // FUNCIONES DE IMPORTACIÓN
        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            showNotification('Procesando archivo...', 'info');
            
            Array.from(files).forEach(function(file) {
                processFile(file).then(function(data) {
                    if (data && data.length > 0) {
                        importData(data);
                    }
                }).catch(function(error) {
                    showNotification('Error procesando archivo: ' + error.message, 'danger');
                });
            });
        }

        function processFile(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (extension === 'xlsx' || extension === 'xls') {
                return processExcelFile(file);
            } else if (extension === 'csv') {
                return processCSVFile(file);
            } else if (extension === 'json') {
                return processJSONFile(file);
            } else {
                return Promise.reject(new Error('Formato no soportado: ' + extension));
            }
        }

        function processExcelFile(file) {
            return new Promise(function(resolve, reject) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        let allData = [];
                        workbook.SheetNames.forEach(function(sheetName) {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            allData = allData.concat(jsonData);
                        });
                        
                        resolve(allData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function processCSVFile(file) {
            return new Promise(function(resolve, reject) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(function(line) { return line.trim(); });
                        
                        if (lines.length < 2) {
                            resolve([]);
                            return;
                        }
                        
                        const headers = lines[0].split(',').map(function(h) { return h.trim(); });
                        const data = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(function(v) { return v.trim(); });
                            if (values.length === headers.length) {
                                const row = {};
                                headers.forEach(function(header, index) {
                                    row[header] = values[index] || '';
                                });
                                data.push(row);
                            }
                        }
                        
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsText(file);
            });
        }

        function processJSONFile(file) {
            return new Promise(function(resolve, reject) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let jsonData = JSON.parse(e.target.result);
                        if (!Array.isArray(jsonData)) {
                            jsonData = [jsonData];
                        }
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsText(file);
            });
        }

        function importData(data) {
            if (!data || data.length === 0) {
                showNotification('No se encontraron datos para importar', 'warning');
                return;
            }

            // Para archivos grandes, procesar por lotes
            if (data.length > 1000) {
                return importLargeDataset(data);
            }

            let imported = 0;
            let suppliersImported = 0;
            let invoicesImported = 0;
            
            // Detectar si es archivo DTE (Documentos Tributarios Electrónicos)
            const isDTEFile = data.length > 0 && data[0]['RUT'] && data[0]['Razón Social'] && data[0]['Folio'];
            
            if (isDTEFile) {
                showNotification('Detectado archivo DTE - Procesando documentos tributarios...', 'info');
                return importDTEData(data);
            } else {
                return importStandardData(data);
            }
        }

        function importLargeDataset(data) {
            const batchSize = 100;
            const totalBatches = Math.ceil(data.length / batchSize);
            let currentBatch = 0;
            let totalImported = 0;

            showNotification(`Procesando archivo grande: ${data.length} registros en ${totalBatches} lotes`, 'info');

            function processBatch() {
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, data.length);
                const batch = data.slice(start, end);
                
                const batchResult = importStandardData(batch);
                totalImported += batchResult;
                currentBatch++;

                // Mostrar progreso
                const progress = Math.round((currentBatch / totalBatches) * 100);
                showNotification(`Procesando lote ${currentBatch}/${totalBatches} (${progress}%)`, 'info');

                if (currentBatch < totalBatches) {
                    // Procesar siguiente lote con delay para evitar bloquear la UI
                    setTimeout(processBatch, 100);
                } else {
                    // Completado
                    saveData();
                    updateAll();
                    showNotification(`Importación masiva completada: ${totalImported} registros procesados`, 'success');
                    
                    // Verificar uso de almacenamiento después de importación grande
                    const storageInfo = checkStorageUsage();
                    if (storageInfo.isNearLimit) {
                        showNotification(`Advertencia: Almacenamiento al ${storageInfo.percentage}% de capacidad`, 'warning');
                    }
                }
            }

            processBatch();
            return totalImported;
        }

        function importDTEData(data) {
            let suppliersImported = 0;
            let invoicesImported = 0;
            
            // Filtrar filas de cabeceras que pueden aparecer como datos
            const cleanData = data.filter(function(item) {
                return item['RUT'] !== 'RUT' && 
                       item['Razón Social'] !== 'Razón Social' &&
                       item['Folio'] && 
                       item['Folio'] !== 'Folio';
            });
            
            // Procesar proveedores únicos del DTE
            const uniqueSuppliers = new Map();
            cleanData.forEach(function(item) {
                const rut = item['RUT'];
                const razonSocial = item['Razón Social'];
                
                if (rut && razonSocial && !uniqueSuppliers.has(rut)) {
                    uniqueSuppliers.set(rut, {
                        rut: rut,
                        name: razonSocial
                    });
                }
            });
            
            // Importar proveedores
            uniqueSuppliers.forEach(function(supplierData) {
                const exists = suppliers.find(function(s) { 
                    return s.ruc === supplierData.rut; 
                });
                
                if (!exists) {
                    const supplier = {
                        id: Date.now() + Math.random(),
                        name: supplierData.name,
                        ruc: supplierData.rut,
                        email: '',
                        phone: '',
                        address: '',
                        category: 'dte-importado',
                        createdAt: new Date().toISOString()
                    };
                    suppliers.push(supplier);
                    suppliersImported++;
                }
            });
            
            // Importar facturas del DTE
            cleanData.forEach(function(item) {
                const folio = item['Folio'];
                const tipoDoc = item['Tipo Documento'];
                const rut = item['RUT'];
                const razonSocial = item['Razón Social'];
                
                // Procesar monto total
                let montoTotal = item['Monto Total'];
                if (typeof montoTotal === 'string') {
                    // Remover puntos de miles y convertir comas a puntos decimales
                    montoTotal = parseFloat(montoTotal.replace(/\./g, '').replace(',', '.'));
                }
                
                // Procesar fecha (si existe)
                let fechaVencimiento = item['Fecha Acuse de Mercadería'];
                if (!fechaVencimiento || fechaVencimiento === 'Fecha Acuse de Mercadería') {
                    // Si no hay fecha, poner 30 días desde hoy
                    const futureDate = new Date();
                    futureDate.setDate(futureDate.getDate() + 30);
                    fechaVencimiento = futureDate.toISOString().split('T')[0];
                } else {
                    // Intentar parsear la fecha existente
                    try {
                        fechaVencimiento = new Date(fechaVencimiento).toISOString().split('T')[0];
                    } catch (e) {
                        const futureDate = new Date();
                        futureDate.setDate(futureDate.getDate() + 30);
                        fechaVencimiento = futureDate.toISOString().split('T')[0];
                    }
                }
                
                // Crear número de factura único
                const invoiceNumber = `${tipoDoc.includes('Factura') ? 'F' : tipoDoc.includes('Nota') ? 'NC' : 'DOC'}-${folio}`;
                
                const exists = invoices.find(function(i) { 
                    return i.invoiceNumber === invoiceNumber; 
                });
                
                if (!exists && montoTotal > 0) {
                    const invoice = {
                        id: Date.now() + Math.random(),
                        supplierId: rut,
                        supplierName: razonSocial,
                        invoiceNumber: invoiceNumber,
                        amount: Math.round(montoTotal),
                        dueDate: fechaVencimiento,
                        costCenter: 'DTE-IMPORT',
                        description: `${tipoDoc} - Importado desde DTE`,
                        status: tipoDoc.includes('Nota de Crédito') ? 'paid' : 'pending',
                        createdAt: new Date().toISOString()
                    };
                    invoices.push(invoice);
                    invoicesImported++;
                }
            });
            
            const totalImported = suppliersImported + invoicesImported;
            showNotification(`DTE procesado: ${suppliersImported} proveedores y ${invoicesImported} documentos importados`, 'success');
            
            saveData();
            updateAll();
            return totalImported;
        }

        function importStandardData(data) {
            let imported = 0;
            
            data.forEach(function(item) {
                // Detectar tipo de datos e importar
                if (item.name && item.ruc) {
                    // Es un proveedor
                    const supplier = {
                        id: Date.now() + Math.random(),
                        name: item.name,
                        ruc: item.ruc,
                        email: item.email || '',
                        phone: item.phone || '',
                        address: item.address || '',
                        category: item.category || 'importado',
                        createdAt: new Date().toISOString()
                    };
                    
                    const exists = suppliers.find(function(s) { return s.ruc === supplier.ruc; });
                    if (!exists) {
                        suppliers.push(supplier);
                        imported++;
                    }
                } else if (item.invoiceNumber && item.amount) {
                    // Es una factura
                    const invoice = {
                        id: Date.now() + Math.random(),
                        supplierId: null,
                        supplierName: item.supplierName || 'Importado',
                        invoiceNumber: item.invoiceNumber,
                        amount: parseFloat(item.amount) || 0,
                        dueDate: item.dueDate || new Date().toISOString().split('T')[0],
                        costCenter: item.costCenter || '',
                        description: item.description || 'Importado',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    };
                    
                    const exists = invoices.find(function(i) { return i.invoiceNumber === invoice.invoiceNumber; });
                    if (!exists) {
                        invoices.push(invoice);
                        imported++;
                    }
                }
            });
            
            if (data.length <= 100) { // Solo mostrar para lotes pequeños
                showNotification('Importación completada: ' + imported + ' registros importados', 'success');
                saveData();
                updateAll();
            }
            
            return imported;
        }

        // FUNCIONES DE INTEGRACIONES REALES
        async function syncBSale() {
            if (!config.bsale.token) {
                showNotification('Configure primero el token BSale', 'warning');
                return;
            }

            try {
                showNotification('Sincronizando con BSale...', 'info');
                
                // ✅ Obtener clientes usando el proxy
                const clientsResponse = await fetch(`/api/bsale-proxy?token=${encodeURIComponent(config.bsale.token)}&endpoint=clients.json`);

                if (clientsResponse.ok) {
                    const clientsData = await clientsResponse.json();
                    let imported = 0;

                    if (clientsData.items && clientsData.items.length > 0) {
                        clientsData.items.forEach(client => {
                            const exists = suppliers.find(s => s.ruc === client.code);
                            if (!exists && client.firstName) {
                                const supplier = {
                                    id: Date.now() + Math.random(),
                                    name: `${client.firstName} ${client.lastName || ''}`.trim(),
                                    ruc: client.code || '',
                                    email: client.email || '',
                                    phone: client.phone || '',
                                    address: client.address || '',
                                    category: 'bsale',
                                    createdAt: new Date().toISOString(),
                                    bsaleId: client.id
                                };
                                suppliers.push(supplier);
                                imported++;
                            }
                        });
                    }

                    // ✅ Obtener documentos usando el proxy
                    const documentsResponse = await fetch(`/api/bsale-proxy?token=${encodeURIComponent(config.bsale.token)}&endpoint=documents.json`);

                    if (documentsResponse.ok) {
                        const documentsData = await documentsResponse.json();
                        
                        if (documentsData.items && documentsData.items.length > 0) {
                            documentsData.items.forEach(doc => {
                                const exists = invoices.find(i => i.invoiceNumber === String(doc.number));
                                if (!exists && doc.number) {
                                    const invoice = {
                                        id: Date.now() + Math.random(),
                                        supplierId: null,
                                        supplierName: doc.client?.firstName || 'BSale',
                                        invoiceNumber: String(doc.number),
                                        amount: doc.totalAmount || 0,
                                        dueDate: doc.expirationDate || new Date().toISOString().split('T')[0],
                                        description: `Importado de BSale - ${doc.documentType?.name || ''}`,
                                        status: doc.state === 0 ? 'pending' : 'paid',
                                        createdAt: new Date().toISOString(),
                                        bsaleId: doc.id
                                    };
                                    invoices.push(invoice);
                                    imported++;
                                }
                            });
                        }
                    }

                    saveData();
                    updateAll();
                    showNotification(`✅ Sincronización completada: ${imported} registros importados`, 'success');
                } else {
                    const error = await clientsResponse.json();
                    showNotification(`❌ Error BSale: ${error.details || error.error}`, 'danger');
                }
            } catch (error) {
                showNotification('❌ Error en sincronización: ' + error.message, 'danger');
                console.error('Error completo:', error);
            }
        }

        function saveEmailSettings() {
            const email = document.getElementById('alertEmail').value;
            const days = document.getElementById('alertDays').value;
            
            if (!email) {
                showNotification('Ingrese email para alertas', 'warning');
                return;
            }
            
            config.email.address = email;
            config.email.days = parseInt(days);
            
            localStorage.setItem('alertEmail', email);
            localStorage.setItem('alertDays', days);
            
            showNotification('Configuración de email guardada', 'success');
        }

        function testGitHubConnection() {
            const token = document.getElementById('githubToken').value;
            const repo = document.getElementById('githubRepo').value;
            
            if (!token || !repo) {
                showNotification('Ingrese token y repositorio de GitHub', 'warning');
                return;
            }
            
            config.github.token = token;
            config.github.repo = repo;
            localStorage.setItem('githubToken', token);
            localStorage.setItem('githubRepo', repo);
            showNotification('Configuración GitHub guardada', 'success');
        }

        function syncToGitHub() {
            if (!config.github.token || !config.github.repo) {
                showNotification('Configure GitHub primero', 'warning');
                return;
            }
            
            const backupData = {
                timestamp: new Date().toISOString(),
                version: '2.0',
                data: { suppliers: suppliers, invoices: invoices, payments: payments }
            };
            
            // Simular subida a GitHub (en producción sería API real)
            showNotification('Datos respaldados en GitHub (simulado)', 'success');
        }

        // FUNCIONES DE RESPALDO
        function exportData() {
            try {
                const wb = XLSX.utils.book_new();
                
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suppliers), 'Proveedores');
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invoices), 'Facturas');
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(payments), 'Pagos');
                
                const fileName = 'ERP-Sistema-Pagos-' + new Date().toISOString().split('T')[0] + '.xlsx';
                XLSX.writeFile(wb, fileName);
                
                showNotification('Datos exportados a Excel correctamente', 'success');
            } catch (error) {
                showNotification('Error exportando a Excel', 'danger');
            }
        }

        function createBackup() {
            const backup = {
                version: '2.0',
                timestamp: new Date().toISOString(),
                data: { suppliers: suppliers, invoices: invoices, payments: payments }
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ERP-Backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Respaldo creado correctamente', 'success');
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (confirm('¿Restaurar respaldo? Esto reemplazará todos los datos actuales.')) {
                        suppliers = backup.data.suppliers || [];
                        invoices = backup.data.invoices || [];
                        payments = backup.data.payments || [];
                        
                        saveData();
                        updateAll();
                        showNotification('Respaldo restaurado correctamente', 'success');
                    }
                } catch (error) {
                    showNotification('Error restaurando respaldo', 'danger');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // INICIALIZACIÓN DE GRÁFICO
        function initializeChart() {
            const ctx = document.getElementById('dashboardChart');
            if (!ctx) return;

            if (dashboardChart) {
                dashboardChart.destroy();
            }

            const last6Months = [];
            const monthlyData = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = month.toLocaleDateString('es-ES', { month: 'short' });
                last6Months.push(monthName);

                const monthTotal = payments
                    .filter(function(p) {
                        const paymentDate = new Date(p.paymentDate);
                        return paymentDate.getMonth() === month.getMonth() && 
                               paymentDate.getFullYear() === month.getFullYear();
                    })
                    .reduce(function(sum, p) { return sum + p.amount; }, 0);

                monthlyData.push(monthTotal);
            }

            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months,
                    datasets: [{
                        label: 'Pagos Realizados',
                        data: monthlyData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function optimizeStorage() {
            // Limpiar registros antiguos (más de 2 años)
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            
            const originalInvoiceCount = invoices.length;
            const originalPaymentCount = payments.length;
            const originalProductCount = products.length;
            
            // Mantener solo facturas de los últimos 2 años
            invoices = invoices.filter(invoice => {
                const createdDate = new Date(invoice.createdAt);
                return createdDate > twoYearsAgo;
            });
            
            // Mantener solo pagos de los últimos 2 años
            payments = payments.filter(payment => {
                const createdDate = new Date(payment.processedAt);
                return createdDate > twoYearsAgo;
            });

            // Mantener productos activos y recientes
            products = products.filter(product => {
                const createdDate = new Date(product.createdAt);
                return createdDate > twoYearsAgo || product.stock > 0;
            });
            
            // Limpiar proveedores sin facturas asociadas
            const usedSupplierIds = [...new Set(invoices.map(i => i.supplierId))];
            const originalSupplierCount = suppliers.length;
            suppliers = suppliers.filter(supplier => 
                usedSupplierIds.includes(supplier.id) || 
                new Date(supplier.createdAt) > twoYearsAgo
            );
            
            // Limpiar configuraciones innecesarias del localStorage
            const keysToKeep = ['suppliers', 'invoices', 'payments', 'products', 'alertEmail', 'alertDays', 'whatsappNumber', 'whatsappDays'];
            Object.keys(localStorage).forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            const cleanedInvoices = originalInvoiceCount - invoices.length;
            const cleanedPayments = originalPaymentCount - payments.length;
            const cleanedSuppliers = originalSupplierCount - suppliers.length;
            const cleanedProducts = originalProductCount - products.length;
            
            showNotification(`Limpieza completada: ${cleanedInvoices} facturas, ${cleanedPayments} pagos, ${cleanedSuppliers} proveedores y ${cleanedProducts} productos antiguos eliminados`, 'info');
        }

        function updateStorageInfo() {
            const storageInfo = checkStorageUsage();
            
            document.getElementById('storageUsage').textContent = `${storageInfo.used} MB (${storageInfo.percentage}%)`;
            document.getElementById('storageBar').style.width = `${Math.min(storageInfo.percentage, 100)}%`;
            
            // Cambiar color de la barra según el uso
            const bar = document.getElementById('storageBar');
            if (storageInfo.percentage < 60) {
                bar.style.background = '#10b981'; // Verde
            } else if (storageInfo.percentage < 80) {
                bar.style.background = '#f59e0b'; // Amarillo
            } else {
                bar.style.background = '#ef4444'; // Rojo
            }
            
            // Actualizar estadísticas de datos
            document.getElementById('statsSuppliers').textContent = suppliers.length;
            document.getElementById('statsInvoices').textContent = invoices.length;
            document.getElementById('statsPay').textContent = payments.length;
            
            // Actualizar botón de optimización
            const optimizeBtn = document.getElementById('optimizeBtn');
            if (storageInfo.isNearLimit) {
                optimizeBtn.textContent = '🔥 Limpiar URGENTE';
                optimizeBtn.className = 'btn btn-danger';
            } else {
                optimizeBtn.textContent = '🧹 Limpiar Antiguos';
                optimizeBtn.className = 'btn btn-warning';
            }
            
            if (storageInfo.isNearLimit && !isFirebaseMode) {
                showNotification(`Almacenamiento al ${storageInfo.percentage}% - Considera usar Firebase para almacenamiento ilimitado`, 'warning');
            }
        }

        function clearAllData() {
            const confirmText = prompt('ADVERTENCIA: Esto eliminará TODOS los datos del sistema.\n\nPara confirmar, escriba "ELIMINAR TODO":');
            
            if (confirmText === 'ELIMINAR TODO') {
                const doubleConfirm = confirm('¿Está COMPLETAMENTE seguro?\n\nEsta acción NO se puede deshacer.');
                
                if (doubleConfirm) {
                    suppliers = [];
                    invoices = [];
                    payments = [];
                    products = [];
                    
                    // Limpiar localStorage
                    localStorage.removeItem('suppliers');
                    localStorage.removeItem('invoices');
                    localStorage.removeItem('payments');
                    localStorage.removeItem('products');
                    
                    updateAll();
                    showNotification('Todos los datos han sido eliminados', 'danger');
                }
            } else if (confirmText !== null) {
                showNotification('Texto de confirmación incorrecto. Operación cancelada.', 'warning');
            }
        }

        // INICIALIZACIÓN DEL SISTEMA
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar configuración de Firebase
            loadFirebaseConfig();
            
            // Intentar inicializar Firebase automáticamente si hay configuración
            if (config.firebase.apiKey && config.firebase.projectId) {
                initializeFirebaseAuto();
            } else {
                updateSyncStatus('local', 'Modo local - Firebase no configurado');
            }
            
            // Cargar datos (local o Firebase según modo)
            const savedFirebaseMode = localStorage.getItem('firebaseMode') === 'true';
            if (savedFirebaseMode && config.firebase.apiKey) {
                isFirebaseMode = true;
                document.getElementById('firebaseToggle').textContent = '☁️ Firebase';
                document.getElementById('firebaseToggle').className = 'btn btn-success';
            }
            
            if (isFirebaseMode) {
                loadDataFirebase().then(() => {
                    updateAll();
                    setDefaultDate();
                    updateStorageInfo();
                });
            } else {
                updateAll();
                setDefaultDate();
                updateStorageInfo();
            }
            
            // Cargar otras configuraciones guardadas
            loadOtherConfigs();

            // Event listeners para calculadora de precios
            const basePriceInput = document.getElementById('productBasePrice');
            if (basePriceInput) {
                basePriceInput.addEventListener('input', updatePriceCalculator);
                basePriceInput.addEventListener('keyup', updatePriceCalculator);
            }
            
            // Auto-guardado cada 2 minutos
            setInterval(saveData, 2 * 60 * 1000);
            
            // Actualizar monitor de almacenamiento cada 30 segundos
            setInterval(updateStorageInfo, 30 * 1000);
            
            // Verificación automática de facturas vencidas al cargar
            setTimeout(function() {
                const today = new Date();
                const overdueInvoices = invoices.filter(function(i) { 
                    return i.status === 'pending' && new Date(i.dueDate) < today; 
                });
                
                if (overdueInvoices.length > 0) {
                    showNotification(`¡Atención! Tienes ${overdueInvoices.length} factura(s) vencida(s)`, 'warning');
                }
                
                // Verificar almacenamiento al cargar (solo en modo local)
                if (!isFirebaseMode) {
                    const storageInfo = checkStorageUsage();
                    if (storageInfo.isNearLimit) {
                        showNotification(`Almacenamiento al ${storageInfo.percentage}% - Considera usar Firebase para almacenamiento ilimitado`, 'warning');
                    }
                }
                
                // Mostrar estadísticas de productos si los hay
                if (products.length > 0) {
                    const lowStockProducts = products.filter(p => p.stock <= 5 && p.stock > 0).length;
                    const outOfStockProducts = products.filter(p => p.stock === 0).length;
                    
                    if (lowStockProducts > 0 || outOfStockProducts > 0) {
                        showNotification(`Inventario: ${lowStockProducts} productos con poco stock, ${outOfStockProducts} sin stock`, 'info');
                    }
                }
            }, 2000);
            
            showNotification('Sistema ERP con Firebase y BSale cargado correctamente', 'success');
        });

        function loadFirebaseConfig() {
            // Cargar configuración de Firebase desde localStorage
            config.firebase.apiKey = localStorage.getItem('firebaseApiKey') || '';
            config.firebase.authDomain = localStorage.getItem('firebaseAuthDomain') || '';
            config.firebase.projectId = localStorage.getItem('firebaseProjectId') || '';
            config.firebase.storageBucket = localStorage.getItem('firebaseStorageBucket') || '';
            config.firebase.messagingSenderId = localStorage.getItem('firebaseMessagingSenderId') || '';
            config.firebase.appId = localStorage.getItem('firebaseAppId') || '';
            
            // Llenar formularios si hay configuración
            if (config.firebase.apiKey) {
                document.getElementById('firebaseApiKey').value = config.firebase.apiKey;
                document.getElementById('firebaseAuthDomain').value = config.firebase.authDomain;
                document.getElementById('firebaseProjectId').value = config.firebase.projectId;
                document.getElementById('firebaseStorageBucket').value = config.firebase.storageBucket;
                document.getElementById('firebaseMessagingSenderId').value = config.firebase.messagingSenderId;
                document.getElementById('firebaseAppId').value = config.firebase.appId;
            }
        }

        function initializeFirebaseAuto() {
            try {
                const firebaseConfig = config.firebase;
                
                if (window.firebase && window.firebase.apps.length === 0) {
                    firebase = window.firebase.initializeApp(firebaseConfig);
                } else if (window.firebase && window.firebase.apps.length > 0) {
                    firebase = window.firebase.app();
                }

                db = firebase.firestore();
                
                // Habilitar persistencia offline
                db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                    console.warn('Persistencia Firebase no disponible:', err);
                });

                document.getElementById('migrateBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;
                
                updateFirebaseStatus('Firebase inicializado automáticamente', 'success');
                
                if (isFirebaseMode) {
                    updateSyncStatus('firebase', 'Conectado a Firebase');
                } else {
                    updateSyncStatus('local', 'Firebase disponible - Modo local activo');
                }
                
            } catch (error) {
                updateFirebaseStatus('Error inicialización automática: ' + error.message, 'error');
                updateSyncStatus('error', 'Error Firebase - Modo local forzado');
                isFirebaseMode = false;
            }
        }

        function loadOtherConfigs() {
            if (config.email.address) {
                document.getElementById('alertEmail').value = config.email.address;
                document.getElementById('alertDays').value = config.email.days;
            }
            
            const whatsappNumber = localStorage.getItem('whatsappNumber');
            const whatsappDays = localStorage.getItem('whatsappDays');
            if (whatsappNumber) {
                document.getElementById('whatsappNumber').value = whatsappNumber;
                document.getElementById('whatsappDays').value = whatsappDays || '3';
            }
            
            if (config.bsale.token) {
                document.getElementById('bsaleToken').value = config.bsale.token;
                document.getElementById('bsaleUrl').value = config.bsale.url;
            }
            
            if (config.github.token) {
                document.getElementById('githubToken').value = config.github.token;
                document.getElementById('githubRepo').value = config.github.repo;
            }
        }

        // ACTUALIZAR FUNCIONES EXISTENTES PARA FIREBASE

        function updateSupplier() {
            if (!currentSupplier) return;

            const updatedData = {
                name: document.getElementById('supplierName').value,
                ruc: document.getElementById('supplierRuc').value,
                email: document.getElementById('supplierEmail').value,
                phone: document.getElementById('supplierPhone').value || '',
                address: document.getElementById('supplierAddress').value || '',
                category: document.getElementById('supplierCategory').value,
                updatedAt: new Date().toISOString()
            };

            if (!updatedData.name || !updatedData.ruc || !updatedData.email) {
                showNotification('Complete los campos obligatorios', 'warning');
                return;
            }

            const index = suppliers.findIndex(s => s.id === currentSupplier.id);
            if (index !== -1) {
                suppliers[index] = { ...suppliers[index], ...updatedData };
                saveData().then(() => {
                    updateSupplierTable();
                    updateSupplierSelect();
                    clearSupplierForm();
                    showNotification('Proveedor actualizado correctamente', 'success');
                });
            }
        }

        function updateInvoice() {
            if (!currentEditInvoice) return;

            const selectEl = document.getElementById('editSupplierSelect');
            const updatedData = {
                supplierId: selectEl.value,
                supplierName: selectEl.options[selectEl.selectedIndex].text,
                invoiceNumber: document.getElementById('editInvoiceNumber').value,
                amount: parseInt(document.getElementById('editAmount').value),
                dueDate: document.getElementById('editDueDate').value,
                costCenter: document.getElementById('editCostCenter').value || '',
                description: document.getElementById('editDescription').value || '',
                updatedAt: new Date().toISOString()
            };

            if (!updatedData.supplierId || !updatedData.invoiceNumber || !updatedData.amount || !updatedData.dueDate) {
                showNotification('Complete todos los campos obligatorios', 'warning');
                return;
            }

            const index = invoices.findIndex(i => i.id === currentEditInvoice.id);
            if (index !== -1) {
                invoices[index] = { ...invoices[index], ...updatedData };
                saveData().then(() => {
                    updateInvoiceTable();
                    updateDashboard();
                    closeEditModal();
                    showNotification('Factura actualizada correctamente', 'success');
                });
            }
        }

        function deletePayment(id) {
            if (!confirm('¿Eliminar este pago? Esta acción cambiará el estado de la factura a pendiente.')) return;

            const payment = payments.find(p => p.id === id);
            if (payment) {
                // Cambiar estado de factura a pendiente
                const invoice = invoices.find(i => i.id === payment.invoiceId);
                if (invoice) {
                    invoice.status = 'pending';
                    delete invoice.paymentDate;
                }
            }

            payments = payments.filter(p => p.id !== id);
            
            // Eliminar de Firebase si está en modo nube
            deleteFromFirebase('payments', id);
            
            saveData().then(() => {
                updatePaymentTable();
                updateInvoiceTable();
                updateDashboard();
                showNotification('Pago eliminado y factura marcada como pendiente', 'success');
            });
        }
    </script>
</body>
</html>
