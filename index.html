<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Empresarial de Pagos - Con Respaldo Autom√°tico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .backup-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 13px;
        }

        .backup-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .tabs {
            display: flex;
            background: #f1f5f9;
            padding: 10px;
            gap: 10px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--gray);
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .backup-panel {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0284c7;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .backup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .backup-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }

        .backup-card h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .backup-card p {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            font-size: 15px;
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.5s;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .backup-history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background: #f8fafc;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid var(--success);
        }

        .backup-item:last-child {
            margin-bottom: 0;
        }

        .backup-info {
            flex: 1;
        }

        .backup-date {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .backup-details {
            font-size: 13px;
            color: var(--gray);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
        }

        .audit-log {
            background: #fafafa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .log-entry {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-icon {
            width: 32px;
            height: 32px;
            background: #e0f2fe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .log-content {
            flex: 1;
        }

        .log-action {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .log-details {
            font-size: 13px;
            color: var(--gray);
        }

        .log-time {
            font-size: 12px;
            color: var(--gray);
        }

        .cloud-sync {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #d1fae5 0%, #bbf7d0 100%);
            border-radius: 20px;
            font-size: 13px;
            color: #065f46;
        }

        .rotating {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                    <line x1="2" y1="10" x2="22" y2="10"></line>
                </svg>
                Sistema Empresarial de Pagos
            </h1>
            <div class="header-actions">
                <div class="backup-status">
                    <div class="backup-indicator"></div>
                    <span id="lastBackupTime">Respaldo autom√°tico activo</span>
                </div>
                <div class="cloud-sync" id="cloudSync" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"></path>
                    </svg>
                    <span>Sincronizando...</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin</span>
                </div>
                <button class="btn btn-warning" onclick="exportToExcel()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    Excel
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('invoices')">Facturas</button>
            <button class="tab" onclick="switchTab('suppliers')">Proveedores</button>
            <button class="tab" onclick="switchTab('payments')">Historial de Pagos</button>
            <button class="tab" onclick="switchTab('import')">Importar y Sincronizar</button>
            <button class="tab" onclick="switchTab('backup')">Respaldo y Seguridad</button>
            <button class="tab" onclick="switchTab('audit')">Auditor√≠a</button>
            <button class="tab" onclick="switchTab('reminders')">Recordatorios</button>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="alert alert-info">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span>Sistema con respaldo autom√°tico cada 5 minutos. √öltima sincronizaci√≥n: <strong id="lastSync">Hace 1 min</strong></span>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Pendiente</h3>
                        <div class="stat-value" id="totalPending">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Facturas Vencidas</h3>
                        <div class="stat-value" id="overdueCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pr√≥ximos Pagos (7 d√≠as)</h3>
                        <div class="stat-value" id="upcomingCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Proveedores</h3>
                        <div class="stat-value" id="supplierCount">0</div>
                    </div>
                </div>

                <div class="alert alert-warning" id="dashboardAlert">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <span id="alertMessage">No hay pagos vencidos</span>
                </div>
            </div>

            <!-- Facturas -->
            <div id="invoices" class="tab-content">
                <h2 style="margin-bottom: 20px;">Registro de Facturas</h2>
                
                <form id="invoiceForm" class="form-grid">
                    <div class="form-group">
                        <label>Proveedor *</label>
                        <select id="supplierSelect" required>
                            <option value="">Seleccionar proveedor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de Factura *</label>
                        <input type="text" id="invoiceNumber" required placeholder="FAC-001">
                    </div>
                    <div class="form-group">
                        <label>Monto *</label>
                        <input type="number" id="amount" required step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Ingreso *</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vencimiento *</label>
                        <input type="date" id="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label>M√©todo de Pago *</label>
                        <select id="paymentMethod" required>
                            <option value="">Seleccionar m√©todo</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="cheque">Cheque</option>
                            <option value="tarjeta">Tarjeta de Cr√©dito</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Centro de Costo</label>
                        <input type="text" id="costCenter" placeholder="CC-001">
                    </div>
                    <div class="form-group">
                        <label>Proyecto</label>
                        <input type="text" id="project" placeholder="Proyecto ABC">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="description" rows="3" placeholder="Detalles de la factura..."></textarea>
                    </div>
                </form>
                
                <button class="btn btn-primary" onclick="addInvoice()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Agregar Factura
                </button>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Factura</th>
                                <th>Proveedor</th>
                                <th>Monto</th>
                                <th>Fecha Ingreso</th>
                                <th>Vencimiento</th>
                                <th>Centro Costo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Proveedores -->
            <div id="suppliers" class="tab-content">
                <h2 style="margin-bottom: 20px;">Gesti√≥n de Proveedores</h2>
                
                <form id="supplierForm" class="form-grid">
                    <input type="hidden" id="supplierId">
                    <div class="form-group">
                        <label>Nombre del Proveedor *</label>
                        <input type="text" id="supplierName" required placeholder="Nombre completo">
                    </div>
                    <div class="form-group">
                        <label>RUC/DNI *</label>
                        <input type="text" id="supplierRuc" required placeholder="12345678901">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="supplierEmail" required placeholder="proveedor@email.com">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="supplierPhone" required placeholder="+51 999 999 999">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="supplierAddress" placeholder="Direcci√≥n completa">
                    </div>
                    <div class="form-group">
                        <label>Contacto Principal</label>
                        <input type="text" id="supplierContact" placeholder="Nombre del contacto">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="supplierCategory">
                            <option value="servicios">Servicios</option>
                            <option value="productos">Productos</option>
                            <option value="consultoria">Consultor√≠a</option>
                            <option value="tecnologia">Tecnolog√≠a</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Datos Bancarios</label>
                        <textarea id="bankDetails" rows="3" placeholder="Banco, cuenta, CCI..."></textarea>
                    </div>
                </form>
                
                <div id="supplier-form-actions" style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveSupplier()">
                         <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        <span id="saveSupplierBtnText">Agregar Proveedor</span>
                    </button>
                     <button class="btn btn-secondary" onclick="cancelEditSupplier()" id="cancelEditBtn" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                           <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        <span>Cancelar Edici√≥n</span>
                    </button>
                </div>


                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>RUC/DNI</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Categor√≠a</th>
                                <th>Contacto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Historial de Pagos -->
            <div id="payments" class="tab-content">
                <h2 style="margin-bottom: 20px;">Historial de Pagos</h2>
                
                <div class="search-box">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="paymentSearch" placeholder="Buscar por factura, proveedor o fecha..." onkeyup="searchPayments()">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha Pago</th>
                                <th>Factura</th>
                                <th>Proveedor</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Usuario</th>
                                <th>Comprobante</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Importar -->
            <div id="import" class="tab-content">
                <h2 style="margin-bottom: 20px;">üîÑ Importador y Sincronizador de Datos</h2>
                
                 <div class="alert alert-info">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span>Importe datos desde archivos o sincronice directamente con la API de BSale.</span>
                </div>

                <div class="backup-panel" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-color: #16a34a;">
                    <h3>üì• Importar y Sincronizar</h3>
                    
                    <div class="backup-grid">
                        <div class="backup-card">
                            <h3>üìÑ Importar Facturas</h3>
                            <p>Importa facturas desde un archivo (JSON, Excel, CSV)</p>
                            <input type="file" id="importInvoicesFile" accept=".json,.xlsx,.xls,.csv" style="display: none;" onchange="handleImportFile(event, 'invoices')">
                            <button class="btn btn-success" onclick="document.getElementById('importInvoicesFile').click()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                Cargar Archivo de Facturas
                            </button>
                        </div>

                        <div class="backup-card">
                            <h3>üë• Importar Proveedores</h3>
                            <p>Importa tu base de proveedores desde un archivo</p>
                            <input type="file" id="importSuppliersFile" accept=".json,.xlsx,.xls,.csv" style="display: none;" onchange="handleImportFile(event, 'suppliers')">
                            <button class="btn btn-primary" onclick="document.getElementById('importSuppliersFile').click()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
                                    <circle cx="8.5" cy="7" r="4"></circle>
                                    <path d="M20 9v6M23 12h-6"></path>
                                </svg>
                                Cargar Archivo de Proveedores
                            </button>
                        </div>
                        
                        <div class="backup-card">
                            <h3>üîÑ Sincronizaci√≥n API con BSale</h3>
                            <p>Conecta directamente para importar facturas pendientes.</p>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label for="bsaleApiToken">Token de API de BSale</label>
                                <input type="password" id="bsaleApiToken" placeholder="Ingrese su token de API">
                            </div>
                            <div style="display:flex; gap: 10px;">
                                <button class="btn btn-secondary" id="setupApiBtn" onclick="setupBSaleAPI()">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    </svg>
                                    Guardar Token
                                </button>
                                <button class="btn btn-primary" id="syncApiBtn" onclick="syncFromBSale()">
                                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21.5 2v6h-6M2.5 22v-6h6"></path>
                                        <path d="M2 11.5a10 10 0 0118.84-4.5M22 12.5a10 10 0 01-18.84 4.5"></path>
                                    </svg>
                                    Sincronizar
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <div style="margin-top: 30px; display: none;" id="fieldMappingContainer">
                    <h3 style="margin-bottom: 20px;"> Mapeo de Campos de Archivo</h3>
                    <div class="alert alert-info">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Por favor, asigne cada campo requerido a la columna correspondiente de su archivo. La vista previa se actualizar√° autom√°ticamente.</span>
                    </div>
                    <div id="fieldMappingUI" class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <!-- El mapeo se generar√° aqu√≠ con JavaScript -->
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">üìä Vista Previa de Importaci√≥n</h3>
                    <div id="importPreview" style="display: none;">
                        <div class="alert alert-warning">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span id="importSummary">Se encontraron 0 registros para importar</span>
                        </div>
                        
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table id="previewTable">
                                <thead id="previewTableHead">
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="confirmImport()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Confirmar Importaci√≥n
                            </button>
                            <button class="btn btn-danger" onclick="cancelImport()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">üìù Historial de Importaciones</h3>
                    <div class="backup-history" id="importHistory">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Respaldo y Seguridad -->
            <div id="backup" class="tab-content">
                <h2 style="margin-bottom: 20px;">Centro de Respaldo y Seguridad</h2>
                
                <div class="backup-panel">
                    <h3>üîê Configuraci√≥n de Respaldo Empresarial</h3>
                    <div class="backup-grid">
                        <div class="backup-card">
                            <h3>üíæ Respaldo Local</h3>
                            <p>Descarga una copia completa de todos tus datos en formato encriptado</p>
                            <button class="btn btn-primary" onclick="createBackup()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                Crear Respaldo
                            </button>
                        </div>
                        
                        <div class="backup-card">
                            <h3>üì• Restaurar Datos</h3>
                            <p>Restaura tus datos desde un archivo de respaldo previo</p>
                            <input type="file" id="restoreFile" accept=".json,.backup" style="display: none;" onchange="restoreBackup(event)">
                            <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4M17 8l-5-5-5 5M12 3v12"/>
                                </svg>
                                Restaurar Respaldo
                            </button>
                        </div>
                        
                        <div class="backup-card">
                            <h3>‚òÅÔ∏è Sincronizaci√≥n Cloud</h3>
                            <p>Configura respaldo autom√°tico en Google Drive o OneDrive</p>
                            <button class="btn btn-success" onclick="setupCloudSync()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"></path>
                                </svg>
                                Configurar Cloud
                            </button>
                        </div>
                        
                        <div class="backup-card">
                            <h3>üìß Respaldo por Email</h3>
                            <p>Env√≠a autom√°ticamente copias de seguridad a tu email corporativo</p>
                            <input type="email" id="backupEmail" placeholder="backup@empresa.com" style="width: 100%; margin-bottom: 12px;">
                            <button class="btn btn-secondary" onclick="configureEmailBackup()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                                    <path d="M22 7l-10 5L2 7"></path>
                                </svg>
                                Configurar Email
                            </button>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 20px;">üìã Historial de Respaldos</h3>
                <div class="backup-history" id="backupHistory">
                    <!-- Se llenar√° din√°micamente -->
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 20px;">‚öôÔ∏è Configuraci√≥n de Seguridad</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Frecuencia de Respaldo Autom√°tico</label>
                        <select id="backupFrequency" onchange="updateBackupFrequency()">
                            <option value="5">Cada 5 minutos</option>
                            <option value="15">Cada 15 minutos</option>
                            <option value="30">Cada 30 minutos</option>
                            <option value="60">Cada hora</option>
                            <option value="1440">Diario</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Retenci√≥n de Respaldos</label>
                        <select id="backupRetention">
                            <option value="7">7 d√≠as</option>
                            <option value="30">30 d√≠as</option>
                            <option value="90">90 d√≠as</option>
                            <option value="365">1 a√±o</option>
                            <option value="0">Indefinido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Encriptaci√≥n</label>
                        <select id="encryptionLevel">
                            <option value="aes256">AES-256 (Recomendado)</option>
                            <option value="aes128">AES-128</option>
                            <option value="none">Sin encriptaci√≥n</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Auditor√≠a -->
            <div id="audit" class="tab-content">
                <h2 style="margin-bottom: 20px;">Registro de Auditor√≠a</h2>
                
                <div class="alert alert-info">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                    <span>Todos los cambios en el sistema son registrados autom√°ticamente para auditor√≠a</span>
                </div>

                <div class="search-box">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="auditSearch" placeholder="Buscar en el registro de auditor√≠a..." onkeyup="searchAudit()">
                </div>

                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Filtrar por Usuario</label>
                        <select id="auditUserFilter" onchange="filterAudit()">
                            <option value="">Todos los usuarios</option>
                            <option value="Admin">Admin</option>
                            <option value="Usuario1">Usuario1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por Acci√≥n</label>
                        <select id="auditActionFilter" onchange="filterAudit()">
                            <option value="">Todas las acciones</option>
                            <option value="create">Creaci√≥n</option>
                            <option value="update">Actualizaci√≥n</option>
                            <option value="delete">Eliminaci√≥n</option>
                            <option value="payment">Pago</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Desde</label>
                        <input type="date" id="auditDateFrom" onchange="filterAudit()">
                    </div>
                    <div class="form-group">
                        <label>Fecha Hasta</label>
                        <input type="date" id="auditDateTo" onchange="filterAudit()">
                    </div>
                </div>

                <div class="audit-log" id="auditLog">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Recordatorios -->
            <div id="reminders" class="tab-content">
                <h2 style="margin-bottom: 20px;">Configuraci√≥n de Recordatorios</h2>
                
                <form class="form-grid">
                    <div class="form-group">
                        <label>D√≠as antes del vencimiento para notificar</label>
                        <input type="number" id="reminderDays" value="3" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label>Email para notificaciones</label>
                        <input type="email" id="notificationEmail" placeholder="admin@empresa.com">
                    </div>
                    <div class="form-group">
                        <label>Hora de env√≠o</label>
                        <input type="time" id="reminderTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label>Canal de notificaci√≥n</label>
                        <select id="notificationChannel">
                            <option value="email">Email</option>
                            <option value="sms">SMS</option>
                            <option value="both">Email y SMS</option>
                            <option value="slack">Slack</option>
                            <option value="teams">Microsoft Teams</option>
                        </select>
                    </div>
                </form>
                
                <button class="btn btn-success" onclick="saveReminderSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Guardar Configuraci√≥n
                </button>

                <h3 style="margin-top: 40px; margin-bottom: 20px;">Pr√≥ximos Vencimientos</h3>
                <div id="upcomingReminders"></div>
            </div>
        </div>
    </div>

    <!-- Modal para pago -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Registrar Pago</h2>
            <form id="paymentModalForm">
                <div class="form-group">
                    <label>Fecha de Pago *</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Operaci√≥n/Referencia</label>
                    <input type="text" id="paymentReference" placeholder="REF-001">
                </div>
                <div class="form-group">
                    <label>Banco/Entidad</label>
                    <input type="text" id="paymentBank" placeholder="Banco XYZ">
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="paymentNotes" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="confirmPayment()">Confirmar Pago</button>
                    <button type="button" class="btn btn-danger" onclick="closePaymentModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para DTE -->
    <div id="dteModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div id="dteContent">
                <p>Cargando DTE...</p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button type="button" class="btn btn-primary" id="createInvoiceFromDTEBtn" style="display:none;">Crear Factura desde DTE</button>
                <button type="button" class="btn btn-danger" onclick="closeDTEModal()">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Sincronizaci√≥n Manual -->
    <div id="manualSyncModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>Asistente de Sincronizaci√≥n Manual</h2>
            <p style="margin-top: 10px; margin-bottom: 20px; color: var(--gray);">La conexi√≥n directa con BSale fue bloqueada por el navegador (error de CORS). Por favor, siga estos pasos para sincronizar manualmente:</p>
            
            <div class="form-group">
                <label>1. Copie este comando:</label>
                <div style="position: relative;">
                    <textarea id="curlCommand" rows="4" readonly style="width: 100%; background: #f1f5f9; font-family: monospace;"></textarea>
                    <button onclick="copyCurlCommand()" style="position: absolute; right: 10px; top: 10px; padding: 5px 10px;" class="btn btn-secondary">Copiar</button>
                </div>
            </div>
            <div class="form-group">
                <label>2. Pegue y ejecute el comando en su terminal (Terminal en Mac, CMD o PowerShell en Windows).</label>
            </div>
            <div class="form-group">
                <label>3. Copie TODA la respuesta JSON de la terminal y p√©guela aqu√≠:</label>
                <textarea id="jsonResponse" rows="8" placeholder="Pegue aqu√≠ la respuesta JSON completa..."></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button type="button" class="btn btn-success" onclick="processManualSync()">Procesar Respuesta</button>
                <button type="button" class="btn btn-danger" onclick="closeManualSyncModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n del sistema
        const SYSTEM_CONFIG = {
            version: '3.1.9', // Versi√≥n actualizada
            company: 'Empresa S.A.',
            backupInterval: 5 * 60 * 1000, // 5 minutos por defecto
            maxBackups: 100,
        };

        // Inicializaci√≥n de datos
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
        let backupHistory = JSON.parse(localStorage.getItem('backupHistory')) || [];
        let importHistory = JSON.parse(localStorage.getItem('importHistory')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || { name: 'Admin', id: 'user001', role: 'admin' };
        let currentPaymentInvoice = null;
        let autoBackupInterval = null;
        
        // Variables globales para el importador
        let originalImportData = null;
        let currentImportType = null;
        let pendingImportData = null;
        let currentDTEData = null;

        // Mapeo de campos flexibles
        const ALIAS_MAPPING = {
            invoiceNumber: ['numero', 'factura', 'folio', 'documento', 'number'],
            amount: ['monto', 'total', 'valor', 'amount'],
            supplierName: ['proveedor', 'nombre', 'razonsocial', 'supplier', 'client'],
            entryDate: ['fechaemision', 'fechaingreso', 'fecha', 'ingreso', 'emision', 'emissiondate'],
            dueDate: ['fechavencimiento', 'vencimiento', 'vence', 'expirationdate', 'duedate'],
            name: ['nombre', 'proveedor', 'razonsocial', 'name', 'company'],
            ruc: ['rut', 'ruc', 'dni', 'identificacion', 'code'],
            email: ['email', 'correo'],
            phone: ['telefono', 'fono', 'movil', 'celular', 'phone'],
            paymentDate: ['fechapago', 'pago', 'recorddate']
        };

        const REQUIRED_FIELDS = {
            invoices: {
                invoiceNumber: 'N√∫mero de Factura',
                amount: 'Monto',
                supplierName: 'Nombre del Proveedor',
                entryDate: 'Fecha de Ingreso',
                dueDate: 'Fecha de Vencimiento'
            },
            suppliers: {
                name: 'Nombre del Proveedor',
                ruc: 'RUC/DNI',
                email: 'Email'
            },
            payments: {
                invoiceNumber: 'N√∫mero de Factura',
                amount: 'Monto',
                paymentDate: 'Fecha de Pago'
            }
        };

        // ============= FUNCIONES B√ÅSICAS Y DE UI =============

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            logAuditEvent('navigation', `Naveg√≥ a ${tabName}`);
            
            if (tabName === 'audit') updateAuditLog();
            if (tabName === 'backup') updateBackupHistory();
            if (tabName === 'import') updateImportHistory();
        }
        
        function showAlert(message, type = 'info', duration = 4000) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 10001; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;
            alertDiv.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;">
                    ${type === 'success' ? '<polyline points="20 6 9 17 4 12"></polyline>' : 
                    type === 'warning' ? '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>' :
                    type === 'danger' ? '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>' :
                    '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'}
                </svg>
                <span>${message}</span>`;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transition = 'opacity 0.5s';
                setTimeout(() => alertDiv.remove(), 500);
            }, duration);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date)) return 'Fecha Inv√°lida';
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('es-CL');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function capitalizeFirst(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        }

        function updateAllViews() {
            if (document.getElementById('supplierTableBody')) updateSupplierTable();
            if (document.getElementById('supplierSelect')) updateSupplierSelect();
            if (document.getElementById('invoiceTableBody')) updateInvoiceTable();
            if (document.getElementById('paymentTableBody')) updatePaymentTable();
            if (document.getElementById('dashboard')) updateDashboard();
            if (document.getElementById('upcomingReminders')) checkForReminders();
        }

        // ============= FUNCIONES DE AUDITOR√çA Y REGISTRO =============
        
        function logAuditEvent(action, description, details = {}) {
            const event = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: currentUser.name, action, description, details
            };
            auditLog.unshift(event);
            if (auditLog.length > 500) auditLog.pop();
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
        }

        function updateAuditLog() {
            const container = document.getElementById('auditLog');
            if (!container) return;
            container.innerHTML = auditLog.length > 0 
                ? auditLog.map(log => `<div>${formatDateTime(log.timestamp)} - ${log.user}: ${log.description}</div>`).join('')
                : '<div>No hay eventos de auditor√≠a.</div>';
        }

        function searchAudit() { /* L√≥gica de b√∫squeda de auditor√≠a */ }
        function filterAudit() { /* L√≥gica de filtro de auditor√≠a */ }

        // ============= FUNCIONES DE RESPALDO Y SEGURIDAD =============
        
        function startAutoBackup() {
            if (autoBackupInterval) clearInterval(autoBackupInterval);
            const frequency = parseInt(localStorage.getItem('backupFrequency') || '5');
            const interval = frequency * 60 * 1000;
            autoBackupInterval = setInterval(autoBackup, interval);
            autoBackup();
        }

        function autoBackup() {
            const backupData = createBackupData();
            const backupEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: 'automatic',
                size: JSON.stringify(backupData).length,
                user: 'Sistema'
            };
            backupHistory.unshift(backupEntry);
            if (backupHistory.length > SYSTEM_CONFIG.maxBackups) backupHistory.pop();
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
            localStorage.setItem(`backup_${backupEntry.id}`, JSON.stringify(backupData));
            updateBackupStatus();
        }

        function createBackupData() {
            return {
                version: SYSTEM_CONFIG.version,
                timestamp: new Date().toISOString(),
                data: { suppliers, invoices, payments, auditLog, importHistory }
            };
        }

        function createBackup() {
            const backupData = createBackupData();
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            logAuditEvent('backup', 'Respaldo manual creado');
            showAlert('Respaldo local creado.', 'success');
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (confirm('¬øRestaurar desde este respaldo? Se sobrescribir√°n los datos actuales.')) {
                        suppliers = backup.data.suppliers || [];
                        invoices = backup.data.invoices || [];
                        payments = backup.data.payments || [];
                        auditLog = backup.data.auditLog || [];
                        importHistory = backup.data.importHistory || [];
                        localStorage.setItem('suppliers', JSON.stringify(suppliers));
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        localStorage.setItem('payments', JSON.stringify(payments));
                        localStorage.setItem('auditLog', JSON.stringify(auditLog));
                        localStorage.setItem('importHistory', JSON.stringify(importHistory));
                        updateAllViews();
                        showAlert('Datos restaurados exitosamente.', 'success');
                        logAuditEvent('restore', 'Datos restaurados desde archivo');
                    }
                } catch (err) {
                    showAlert('Error al leer el archivo de respaldo.', 'danger');
                }
            };
            reader.readAsText(file);
        }

        function updateBackupStatus() {
            const lastBackup = backupHistory[0];
            const statusEl = document.getElementById('lastBackupTime');
            const syncEl = document.getElementById('lastSync');
            if (lastBackup && statusEl) {
                const minutes = Math.floor((Date.now() - new Date(lastBackup.timestamp).getTime()) / 60000);
                const text = `Respaldo: Hace ${minutes < 1 ? 'instantes' : `${minutes} min`}`;
                statusEl.textContent = text;
                if(syncEl) syncEl.parentElement.querySelector('strong').textContent = `Hace ${minutes < 1 ? 'instantes' : `${minutes} min`}`;
            }
        }
        
        function updateBackupHistory() {
            const container = document.getElementById('backupHistory');
            if (!container) return;
            container.innerHTML = backupHistory.length > 0
                ? backupHistory.map(b => `<div class="backup-item"><div><div class="backup-date">${formatDateTime(b.timestamp)}</div><div class="backup-details">Tipo: ${b.type} | Tama√±o: ${formatFileSize(b.size)}</div></div></div>`).join('')
                : '<div>No hay respaldos registrados.</div>';
        }

        function setupCloudSync() { showAlert('Funci√≥n no implementada.', 'info'); }
        function configureEmailBackup() { showAlert('Funci√≥n no implementada.', 'info'); }
        function updateBackupFrequency() {
            const frequency = document.getElementById('backupFrequency').value;
            localStorage.setItem('backupFrequency', frequency);
            showAlert(`Frecuencia de respaldo actualizada a cada ${frequency} minutos.`, 'success');
            startAutoBackup();
        }

        // ============= FUNCIONES DE IMPORTACI√ìN Y SINCRONIZACI√ìN =============
        
        async function handleImportFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            cancelImport();
            showAlert('Procesando archivo...', 'info');
            
            try {
                let data;
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.json')) {
                    const text = await readFileAsText(file);
                    data = JSON.parse(text);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.csv')) {
                    data = await (fileName.endsWith('.csv') ? readCSVFile(file) : readExcelFile(file));
                } else {
                    throw new Error('Formato de archivo no soportado.');
                }

                if (!data || data.length === 0) {
                    throw new Error('El archivo est√° vac√≠o o no se pudo leer.');
                }
                
                originalImportData = data;
                currentImportType = type;

                const headers = Object.keys(originalImportData[0]);
                setupInteractiveMapping(headers, type);
                
            } catch (error) {
                showAlert(`Error al procesar el archivo: ${error.message}`, 'danger');
                logAuditEvent('import_error', 'Error en importaci√≥n de archivo', { error: error.message, type });
                cancelImport();
            } finally {
                event.target.value = '';
            }
        }
        
        function setupInteractiveMapping(headers, type) {
            const mappingContainer = document.getElementById('fieldMappingContainer');
            const mappingUI = document.getElementById('fieldMappingUI');
            
            mappingUI.innerHTML = '';
            const required = REQUIRED_FIELDS[type];

            Object.keys(required).forEach(fieldKey => {
                const fieldLabel = required[fieldKey];
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.textContent = `${fieldLabel} *`;
                
                const select = document.createElement('select');
                select.id = `map_${fieldKey}`;
                select.onchange = regeneratePreview;
                
                select.add(new Option(`-- No importar este campo --`, 'ignore'));
                headers.forEach(header => select.add(new Option(header, header)));

                select.value = findBestHeaderMatch(fieldKey, headers) || 'ignore';

                formGroup.appendChild(label);
                formGroup.appendChild(select);
                mappingUI.appendChild(formGroup);
            });
            
            mappingContainer.style.display = 'block';
            regeneratePreview();
        }

        function findBestHeaderMatch(fieldKey, headers) {
            const aliases = ALIAS_MAPPING[fieldKey] || [fieldKey];
            for (const header of headers) {
                const cleanHeader = header.toLowerCase()
                                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                                        .replace(/[^a-z0-9]/g, '');
        
                for (const alias of aliases) {
                    if (cleanHeader.includes(alias)) {
                        return header;
                    }
                }
            }
            return null;
        }

        function regeneratePreview() {
            if (!originalImportData) return;
            
            const userMapping = {};
            Object.keys(REQUIRED_FIELDS[currentImportType]).forEach(fieldKey => {
                const select = document.getElementById(`map_${fieldKey}`);
                if (select && select.value !== 'ignore') {
                    userMapping[fieldKey] = select.value;
                }
            });

            const { valid, invalid } = processDataWithMapping(originalImportData, currentImportType, userMapping);
            showImportPreview(valid, invalid, currentImportType);
        }

        function processDataWithMapping(rawData, type, mapping) {
            const validRows = [];
            const invalidRows = [];

            rawData.forEach((row, index) => {
                const newItem = {};
                let validationIssues = [];
                
                Object.keys(mapping).forEach(fieldKey => {
                    newItem[fieldKey] = row[mapping[fieldKey]];
                });

                if (type === 'suppliers') {
                    if (!newItem.name && !newItem.ruc && !newItem.email) {
                        validationIssues.push("Debe tener al menos un Nombre, RUC/DNI o Email.");
                    }
                } else {
                    Object.keys(REQUIRED_FIELDS[type]).forEach(reqField => {
                        if (reqField in newItem) { // Only validate if the field is being mapped
                            const value = newItem[reqField];
                            if (value == null || String(value).trim() === '') {
                                validationIssues.push(`Campo '${REQUIRED_FIELDS[type][reqField]}' est√° vac√≠o.`);
                            }
                        }
                    });
                }
                
                if ('amount' in newItem) {
                    newItem.amount = parseFloat(String(newItem.amount || '0').replace(/[^0-9.-]+/g,""));
                    if (isNaN(newItem.amount)) validationIssues.push("Valor de 'Monto' no es un n√∫mero v√°lido.");
                }
                if ('entryDate' in newItem) {
                    newItem.entryDate = formatImportedDate(newItem.entryDate);
                    if (!newItem.entryDate && newItem.entryDate !== undefined) validationIssues.push("Formato de fecha inv√°lido para 'Fecha de Ingreso'.");
                }
                if ('dueDate' in newItem) {
                    newItem.dueDate = formatImportedDate(newItem.dueDate);
                     if (!newItem.dueDate && newItem.dueDate !== undefined) validationIssues.push("Formato de fecha inv√°lido para 'Fecha de Vencimiento'.");
                }
                if ('paymentDate' in newItem) {
                    newItem.paymentDate = formatImportedDate(newItem.paymentDate);
                    if (!newItem.paymentDate && newItem.paymentDate !== undefined) validationIssues.push("Formato de fecha inv√°lido para 'Fecha de Pago'.");
                }
                
                if (validationIssues.length > 0) {
                    invalidRows.push({ rowNumber: index + 2, issues: [...new Set(validationIssues)].join(' '), originalData: row });
                } else {
                    validRows.push(newItem);
                }
            });
            return { valid: validRows, invalid: invalidRows };
        }

        function formatImportedDate(dateValue) {
            if (!dateValue) return null;
            
            if (dateValue instanceof Date && !isNaN(dateValue)) {
                return dateValue.toISOString().split('T')[0];
            }
            
            if (typeof dateValue === 'number' && dateValue > 1000) {
                const jsDate = new Date(Math.round((dateValue - 25569) * 86400000));
                 if (!isNaN(jsDate)) return jsDate.toISOString().split('T')[0];
            }

            if (typeof dateValue !== 'string') return null;

            const cleanedDate = dateValue.trim();
            let parts;

            parts = cleanedDate.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
            if (parts) {
                const y = parseInt(parts[1]), m = parseInt(parts[2]), d = parseInt(parts[3]);
                const date = new Date(Date.UTC(y, m - 1, d));
                if (date.getUTCFullYear() === y && date.getUTCMonth() === m - 1) return date.toISOString().split('T')[0];
            }

            parts = cleanedDate.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})$/);
            if (parts) {
                let d = parseInt(parts[1]), m = parseInt(parts[2]), y = parseInt(parts[3]);
                if (y < 100) y += 2000;
                let date = new Date(Date.UTC(y, m - 1, d)); // Try DD-MM-YYYY
                if (date.getUTCDate() === d && date.getUTCMonth() === m - 1) return date.toISOString().split('T')[0];
                date = new Date(Date.UTC(y, d - 1, m)); // Try MM-DD-YYYY
                if (date.getUTCDate() === m && date.getUTCMonth() === d - 1) return date.toISOString().split('T')[0];
            }
            
            try {
                const parsedDate = new Date(cleanedDate);
                if (!isNaN(parsedDate)) return parsedDate.toISOString().split('T')[0];
            } catch (e) {}

            return null;
        }


        function showImportPreview(validData, invalidData, type) {
            pendingImportData = validData;
            originalImportData = [...validData, ...invalidData.map(i => i.originalData)];
            
            const previewContainer = document.getElementById('importPreview');
            const summary = document.getElementById('importSummary');
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (validData.length === 0) {
                const discardedCount = (originalImportData.length || 0);
                summary.innerHTML = `No se encontraron registros v√°lidos. <strong>${discardedCount} filas fueron descartadas.</strong>`;
                
                if (invalidData.length > 0) {
                    let examplesHtml = '<h5 style="margin-top:10px;">Ejemplos de errores:</h5><ul style="font-size: 13px; max-height: 100px; overflow-y: auto;">';
                    invalidData.slice(0, 5).forEach(item => {
                        examplesHtml += `<li><strong>Fila ${item.rowNumber}:</strong> ${item.issues}</li>`;
                    });
                    examplesHtml += '</ul><p style="font-size:12px; margin-top:5px;">Revise la consola del navegador (F12) para ver todos los errores.</p>';
                    summary.innerHTML += examplesHtml;
                }
                previewContainer.style.display = 'block';
                return;
            }
            
            summary.textContent = `Se importar√°n ${validData.length} de ${originalImportData.length} registros.`;
            
            const headers = Object.values(REQUIRED_FIELDS[type]);
            const headerRow = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            validData.slice(0, 10).forEach(item => {
                const row = document.createElement('tr');
                Object.keys(REQUIRED_FIELDS[type]).forEach(fieldKey => {
                    const td = document.createElement('td');
                    let value = item[fieldKey] || 'N/A';
                    if (fieldKey.toLowerCase().includes('date')) value = formatDate(value);
                    if (fieldKey === 'amount') value = `$${(value || 0).toFixed(2)}`;
                    td.textContent = value;
                    row.appendChild(td);
                });
                tableBody.appendChild(row);
            });
            
            previewContainer.style.display = 'block';
        }

        function confirmImport() {
            if (!pendingImportData || pendingImportData.length === 0) {
                showAlert('No hay datos v√°lidos para importar.', 'warning');
                return;
            }

            let importedCount = 0;
            if (currentImportType === 'invoices') {
                pendingImportData.forEach(item => {
                    const original = originalImportData.find(orig => orig.number == item.invoiceNumber || orig[findBestHeaderMatch('invoiceNumber', Object.keys(orig))] == item.invoiceNumber);
                    const bsaleId = original ? original.id : undefined;
                    invoices.push({ ...item, bsaleId, id: Date.now() + Math.random(), status: 'pending', createdBy: currentUser.name });
                    importedCount++;
                });
                localStorage.setItem('invoices', JSON.stringify(invoices));
            } else if (currentImportType === 'suppliers') {
                pendingImportData.forEach(item => {
                    suppliers.push({ ...item, id: Date.now() + Math.random(), createdBy: currentUser.name });
                    importedCount++;
                });
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
            } else if (currentImportType === 'payments') {
                 pendingImportData.forEach(item => {
                    payments.push({ ...item, id: Date.now() + Math.random(), processedBy: currentUser.name });
                     const invoice = invoices.find(inv => inv.invoiceNumber === item.invoiceNumber);
                    if (invoice) invoice.status = 'paid';
                    importedCount++;
                });
                localStorage.setItem('payments', JSON.stringify(payments));
                localStorage.setItem('invoices', JSON.stringify(invoices));
            }

            logAuditEvent('import', `Importaci√≥n de ${currentImportType} completada`, { count: importedCount });
            showAlert(`${importedCount} registros importados exitosamente.`, 'success');
            
            updateImportHistory();
            updateAllViews();
            cancelImport();
        }

        function cancelImport() {
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fieldMappingContainer').style.display = 'none';
            originalImportData = null;
            currentImportType = null;
            pendingImportData = null;
        }

        function updateImportHistory() {
            const container = document.getElementById('importHistory');
            if (!container) return;
            container.innerHTML = importHistory.length > 0 
                ? importHistory.map(rec => `<div>${formatDateTime(rec.timestamp)} - ${rec.type}: ${rec.stats.imported} importados.</div>`).join('')
                : '<div>No hay importaciones previas.</div>';
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        function readCSVFile(file) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'string', cellDates: true });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null }));
                    } catch (err) { reject(err); }
                };
                 reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function setupBSaleAPI() {
            const token = document.getElementById('bsaleApiToken').value;
            if (!token) {
                showAlert('Por favor, ingrese un token de API.', 'warning');
                return;
            }
            localStorage.setItem('bsaleApiToken', token);
            showAlert('Token de API de BSale guardado.', 'success');
            logAuditEvent('settings', 'Token de BSale configurado.');
        }

        async function syncFromBSale() {
            const apiToken = localStorage.getItem('bsaleApiToken');
            if (!apiToken) {
                showAlert('Primero debe guardar un token de API de BSale.', 'warning');
                return;
            }

            const startDate = prompt('Sincronizar facturas desde la fecha (AAAA-MM-DD):', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            if (!startDate) return;

            showAlert('Sincronizando con BSale...', 'info');
            const url = `https://api.bsale.cl/v1/documents.json?limit=50&state=0&since_emission_date=${startDate}`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'access-token': apiToken, 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Error de la API de BSale: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    currentImportType = 'invoices';
                    const { valid, invalid } = processApiData(data.items, 'invoices');
                    originalImportData = data.items;
                    showImportPreview(valid, invalid, 'invoices');
                    showAlert(`Se encontraron ${valid.length} facturas nuevas.`, 'success');
                } else {
                    showAlert('No se encontraron nuevas facturas pendientes desde la fecha indicada.', 'info');
                }

            } catch(error) {
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    showAlert('La conexi√≥n directa fall√≥ (posible error de CORS). Abriendo asistente manual.', 'warning', 6000);
                    openManualSyncAssistant(url, apiToken);
                } else {
                    showAlert(`Error de sincronizaci√≥n: ${error.message}`, 'danger');
                    logAuditEvent('import_error', 'Error en sincronizaci√≥n con BSale', { error: error.message });
                }
            }
        }
        
        function openManualSyncAssistant(url, token) {
            const modal = document.getElementById('manualSyncModal');
            document.getElementById('curlCommand').value = `curl -H "access-token: ${token}" -H "Content-Type: application/json" "${url}"`;
            document.getElementById('jsonResponse').value = '';
            modal.classList.add('active');
        }

        function closeManualSyncModal() {
            document.getElementById('manualSyncModal').classList.remove('active');
        }

        function copyCurlCommand() {
            const commandText = document.getElementById('curlCommand');
            commandText.select();
            document.execCommand('copy');
            showAlert('Comando copiado al portapapeles.', 'success');
        }

        function processManualSync() {
            const jsonText = document.getElementById('jsonResponse').value;
            if (!jsonText) {
                showAlert('Por favor, pegue la respuesta JSON de la terminal.', 'warning');
                return;
            }

            try {
                const data = JSON.parse(jsonText);
                if (data.items && data.items.length > 0) {
                    currentImportType = 'invoices';
                    const { valid, invalid } = processApiData(data.items, 'invoices');
                    originalImportData = data.items;
                    showImportPreview(valid, invalid, 'invoices');
                    showAlert(`Se procesaron ${valid.length} facturas desde la respuesta manual.`, 'success');
                    closeManualSyncModal();
                } else {
                     showAlert('La respuesta JSON no contiene facturas o es inv√°lida.', 'warning');
                }
            } catch(error) {
                showAlert(`Error al procesar el JSON: ${error.message}`, 'danger');
            }
        }

        function getNestedProperty(obj, path) {
            return path.split('.').reduce((o, p) => (o && o[p] != null) ? o[p] : null, obj);
        }

        function formatApiTimestamp(timestamp) {
            if (!timestamp) return null;
            const date = new Date(timestamp * 1000);
            if (isNaN(date)) return null;
            return date.toISOString().split('T')[0];
        }

        function processApiData(apiItems, type) {
            const apiMapping = {
                invoices: {
                    'number': 'invoiceNumber',
                    'totalAmount': 'amount',
                    'client.name': 'supplierName',
                    'emissionDate': 'entryDate',
                    'expirationDate': 'dueDate'
                }
            };

            const mapping = apiMapping[type];
            if (!mapping) return { valid: [], invalid: [] };
            
            const validRows = [];
            const invalidRows = [];

            apiItems.forEach((item, index) => {
                const newItem = { bsaleId: item.id };
                let validationIssues = [];

                for (const apiPath in mapping) {
                    newItem[mapping[apiPath]] = getNestedProperty(item, apiPath);
                }

                if ('amount' in newItem) newItem.amount = parseFloat(newItem.amount);
                if ('entryDate' in newItem) newItem.entryDate = formatApiTimestamp(newItem.entryDate);
                if ('dueDate' in newItem) newItem.dueDate = formatApiTimestamp(newItem.dueDate);

                Object.keys(REQUIRED_FIELDS[type]).forEach(reqField => {
                    const value = newItem[reqField];
                     if (value == null || value === '') {
                        validationIssues.push(`Campo '${REQUIRED_FIELDS[type][reqField]}' est√° vac√≠o.`);
                    } else if (reqField.toLowerCase().includes('date') && value === null) {
                         validationIssues.push(`Formato de fecha inv√°lido para '${REQUIRED_FIELDS[type][reqField]}'.`);
                    } else if (reqField === 'amount' && isNaN(value)) {
                         validationIssues.push(`Valor de '${REQUIRED_FIELDS[type][reqField]}' no es un n√∫mero v√°lido.`);
                    }
                });

                if (validationIssues.length > 0) {
                    invalidRows.push({ rowNumber: index + 1, issues: validationIssues.join(' '), originalData: item });
                } else {
                    validRows.push(newItem);
                }
            });

            return { valid: validRows, invalid: invalidRows };
        }

        async function viewDTE(bsaleId) {
            const modal = document.getElementById('dteModal');
            const content = document.getElementById('dteContent');
            const createBtn = document.getElementById('createInvoiceFromDTEBtn');
            
            modal.classList.add('active');
            content.innerHTML = '<p>Cargando DTE...</p>';
            createBtn.style.display = 'none';
            
            const apiToken = localStorage.getItem('bsaleApiToken');
            if (!apiToken) {
                content.innerHTML = '<p style="color:red;">Error: Token de API de BSale no configurado.</p>';
                return;
            }

            try {
                const url = `https://api.bsale.cl/v1/documents/${bsaleId}/xml.json`;
                const response = await fetch(url, {
                    headers: { 'access-token': apiToken, 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error(`Token de API inv√°lido o expirado. Verifique su token.`);
                    if (response.status === 404) throw new Error(`No se encontr√≥ el documento con ID ${bsaleId} en BSale.`);
                    throw new Error(`Error de la API de BSale (${response.status}): ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!data.xml) {
                    throw new Error('La respuesta de BSale no contiene el XML del DTE. Es posible que este documento no sea un DTE.');
                }

                const xmlString = atob(data.xml);
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");

                if (xmlDoc.querySelector("parsererror")) {
                     console.error("Error de parseo del XML:", xmlDoc.querySelector("parsererror").textContent);
                    throw new Error("El XML del DTE es inv√°lido o no se pudo interpretar.");
                }
                
                currentDTEData = parseDTE_XML(xmlDoc);
                if(!currentDTEData) {
                    throw new Error("No se pudo extraer la informaci√≥n del DTE. La estructura del XML puede no ser la esperada.");
                }
                
                content.innerHTML = renderDTE(currentDTEData);
                createBtn.onclick = () => createInvoiceFromDTE(currentDTEData);
                createBtn.style.display = 'inline-flex';

            } catch (error) {
                content.innerHTML = `<div class='alert alert-danger' style='margin-bottom:0;'><b>Error al obtener DTE:</b> ${error.message}</div>`;
                console.error("Error fetching/parsing DTE:", error);
            }
        }

        function closeDTEModal() {
            document.getElementById('dteModal').classList.remove('active');
            currentDTEData = null;
        }
        
        function parseDTE_XML(xmlDoc) {
            try {
                const getText = (context, selector) => context.querySelector(selector)?.textContent || null;
                
                const doc = xmlDoc.querySelector('Documento');
                if (!doc) {
                    console.error("No se encontr√≥ la etiqueta <Documento> en el DTE XML.");
                    return null;
                }

                const encabezado = doc.querySelector('Encabezado');
                if (!encabezado) {
                    console.error("No se encontr√≥ la etiqueta <Encabezado> en el DTE XML.");
                    return null;
                }

                const idDoc = encabezado.querySelector('IdDoc');
                const emisor = encabezado.querySelector('Emisor');
                const receptor = encabezado.querySelector('Receptor');
                const totales = encabezado.querySelector('Totales');

                const detalles = Array.from(doc.querySelectorAll('Detalle')).map(det => ({
                    nombre: getText(det, 'NmbItem'),
                    cantidad: getText(det, 'QtyItem'),
                    precio: getText(det, 'PrcItem'),
                    monto: getText(det, 'MontoItem')
                }));

                return {
                    folio: getText(idDoc, 'Folio'),
                    tipoDTE: getText(idDoc, 'TipoDTE'),
                    fechaEmision: getText(idDoc, 'FchEmis'),
                    emisorRUT: getText(emisor, 'RUTEmisor'),
                    emisorRazonSocial: getText(emisor, 'RznSoc'),
                    emisorGiro: getText(emisor, 'GiroEmis'),
                    emisorDireccion: getText(emisor, 'DirOrigen'),
                    emisorComuna: getText(emisor, 'CmnaOrigen'),
                    receptorRUT: getText(receptor, 'RUTRecep'),
                    receptorRazonSocial: getText(receptor, 'RznSocRecep'),
                    montoNeto: getText(totales, 'MntNeto'),
                    iva: getText(totales, 'IVA'),
                    montoTotal: getText(totales, 'MntTotal'),
                    detalles: detalles
                };
            } catch (e) {
                console.error("Error cr√≠tico durante el parseo del XML:", e, xmlDoc);
                return null;
            }
        }

        function renderDTE(dte) {
            const itemsHtml = dte.detalles.map(item => `
                <tr>
                    <td>${item.nombre}</td>
                    <td style="text-align:right;">${parseFloat(item.cantidad || 1).toLocaleString('es-CL')}</td>
                    <td style="text-align:right;">${(item.precio) ? '$' + parseInt(item.precio).toLocaleString('es-CL') : 'N/A'}</td>
                    <td style="text-align:right;">$${parseInt(item.monto).toLocaleString('es-CL')}</td>
                </tr>`).join('');

            return `
                <h2 style="margin-bottom: 20px; text-align:center;">Documento Tributario Electr√≥nico</h2>
                <div style="display:flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong>Emisor:</strong> ${dte.emisorRazonSocial}<br>
                        <strong>RUT:</strong> ${dte.emisorRUT}<br>
                        <strong>Giro:</strong> ${dte.emisorGiro || 'No especificado'}<br>
                        <strong>Direcci√≥n:</strong> ${dte.emisorDireccion || ''}, ${dte.emisorComuna || ''}
                    </div>
                    <div style="text-align:right; border: 2px solid var(--danger); padding: 10px; border-radius: 8px;">
                         <strong>R.U.T.: ${dte.emisorRUT}</strong><br>
                         <strong style="color:var(--danger);">FACTURA ELECTR√ìNICA</strong><br>
                         <strong>N¬∫ ${dte.folio}</strong>
                    </div>
                </div>
                 <hr style="margin: 15px 0;">
                <div>
                     <strong>Receptor:</strong> ${dte.receptorRazonSocial}<br>
                     <strong>RUT:</strong> ${dte.receptorRUT}<br>
                     <strong>Fecha Emisi√≥n:</strong> ${formatDate(dte.fechaEmision)}
                </div>
                 <hr style="margin: 15px 0;">
                <table style="width:100%; border-collapse: collapse;">
                    <thead style="background:#f1f5f9;">
                        <tr>
                            <th style="padding:8px; text-align:left;">Descripci√≥n</th>
                            <th style="padding:8px; text-align:right;">Cant.</th>
                            <th style="padding:8px; text-align:right;">P. Unit</th>
                            <th style="padding:8px; text-align:right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                    <tfoot>
                        <tr><td colspan="4"><hr style="margin: 10px 0;"></td></tr>
                        <tr>
                            <td colspan="2"></td>
                            <td style="text-align:right; font-weight:bold;">NETO:</td>
                            <td style="text-align:right;">$${parseInt(dte.montoNeto || 0).toLocaleString('es-CL')}</td>
                        </tr>
                         <tr>
                            <td colspan="2"></td>
                            <td style="text-align:right; font-weight:bold;">IVA (19%):</td>
                            <td style="text-align:right;">$${parseInt(dte.iva || 0).toLocaleString('es-CL')}</td>
                        </tr>
                         <tr>
                            <td colspan="2"></td>
                            <td style="text-align:right; font-weight:bold; font-size: 1.2em;">TOTAL:</td>
                            <td style="text-align:right; font-weight:bold; font-size: 1.2em;">$${parseInt(dte.montoTotal || 0).toLocaleString('es-CL')}</td>
                        </tr>
                    </tfoot>
                </table>`;
        }
        
        function createInvoiceFromDTE(dteData) {
            closeDTEModal();
            switchTab('invoices');

            const supplier = suppliers.find(s => s.ruc === dteData.emisorRUT);

            document.getElementById('invoiceNumber').value = dteData.folio;
            document.getElementById('amount').value = dteData.montoTotal;
            document.getElementById('entryDate').value = dteData.fechaEmision;
            const dueDate = new Date(dteData.fechaEmision);
            dueDate.setDate(dueDate.getDate() + 31); // Vencimiento a 30 d√≠as
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            
            const description = dteData.detalles.map(d => `${d.cantidad || 1} x ${d.nombre}`).join('\n');
            document.getElementById('description').value = description;

            if (supplier) {
                document.getElementById('supplierSelect').value = supplier.id;
                showAlert(`Factura pre-rellenada. Proveedor "${supplier.name}" encontrado.`, 'success');
            } else {
                showAlert(`Factura pre-rellenada. Proveedor con RUT ${dteData.emisorRUT} no encontrado. Por favor, cr√©elo y selecci√≥nelo.`, 'warning', 6000);
            }
        }
        
        // ============= FUNCIONES CRUD Y OTRAS UTILIDADES =============

        function addInvoice() {
            const invoice = {
                id: Date.now(),
                supplierId: document.getElementById('supplierSelect').value,
                supplierName: document.getElementById('supplierSelect').options[document.getElementById('supplierSelect').selectedIndex].text,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                amount: parseFloat(document.getElementById('amount').value),
                entryDate: document.getElementById('entryDate').value,
                dueDate: document.getElementById('dueDate').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                costCenter: document.getElementById('costCenter').value,
                project: document.getElementById('project').value,
                description: document.getElementById('description').value,
                status: 'pending', createdBy: currentUser.name, createdAt: new Date().toISOString()
            };
            if (!invoice.supplierId || !invoice.invoiceNumber || !invoice.amount || !invoice.entryDate || !invoice.dueDate) {
                showAlert('Por favor complete todos los campos obligatorios.', 'warning'); return;
            }
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            logAuditEvent('create', `Factura agregada: ${invoice.invoiceNumber}`, { id: invoice.id });
            updateInvoiceTable();
            document.getElementById('invoiceForm').reset();
            showAlert('Factura agregada exitosamente.', 'success');
        }

        function saveSupplier() {
            const supplierId = document.getElementById('supplierId').value;
            const supplierData = {
                name: document.getElementById('supplierName').value,
                ruc: document.getElementById('supplierRuc').value,
                email: document.getElementById('supplierEmail').value,
                phone: document.getElementById('supplierPhone').value,
                address: document.getElementById('supplierAddress').value,
                contact: document.getElementById('supplierContact').value,
                category: document.getElementById('supplierCategory').value,
                bankDetails: document.getElementById('bankDetails').value,
            };

            if (!supplierData.name || !supplierData.ruc || !supplierData.email) {
                showAlert('Por favor complete los campos obligatorios.', 'warning');
                return;
            }

            if (supplierId) {
                const index = suppliers.findIndex(s => s.id == supplierId);
                if (index > -1) {
                    suppliers[index] = { ...suppliers[index], ...supplierData };
                    logAuditEvent('update', `Proveedor actualizado: ${supplierData.name}`, { id: supplierId });
                    showAlert('Proveedor actualizado.', 'success');
                }
            } else {
                const newSupplier = { ...supplierData, id: Date.now(), createdBy: currentUser.name, createdAt: new Date().toISOString() };
                suppliers.push(newSupplier);
                logAuditEvent('create', `Proveedor agregado: ${newSupplier.name}`, { id: newSupplier.id });
                showAlert('Proveedor agregado.', 'success');
            }
            
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            cancelEditSupplier(); 
            updateSupplierTable();
            updateSupplierSelect();
        }
        
        function editSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (supplier) {
                document.getElementById('supplierId').value = supplier.id;
                document.getElementById('supplierName').value = supplier.name;
                document.getElementById('supplierRuc').value = supplier.ruc;
                document.getElementById('supplierEmail').value = supplier.email;
                document.getElementById('supplierPhone').value = supplier.phone;
                document.getElementById('supplierAddress').value = supplier.address || '';
                document.getElementById('supplierContact').value = supplier.contact || '';
                document.getElementById('supplierCategory').value = supplier.category || 'servicios';
                document.getElementById('bankDetails').value = supplier.bankDetails || '';
                
                document.getElementById('saveSupplierBtnText').textContent = 'Guardar Cambios';
                document.getElementById('cancelEditBtn').style.display = 'inline-flex';
                
                switchTab('suppliers');
                showAlert('Editando proveedor. Guarde o cancele los cambios.', 'info');
            }
        }

        function cancelEditSupplier() {
            document.getElementById('supplierForm').reset();
            document.getElementById('supplierId').value = '';
            document.getElementById('saveSupplierBtnText').textContent = 'Agregar Proveedor';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function updateSupplierTable() {
            const tbody = document.getElementById('supplierTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            suppliers.forEach(s => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${s.name}</td><td>${s.ruc}</td><td>${s.email}</td><td>${s.phone}</td><td>${s.category}</td><td>${s.contact}</td>
                    <td class="action-buttons">
                         <button class="icon-btn" style="background: #dbeafe; color: #1e40af;" onclick="editSupplier(${s.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="icon-btn" style="background: #fee2e2; color: #991b1b;" onclick="deleteSupplier(${s.id})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></svg>
                        </button>
                    </td>`;
            });
        }
        function updateInvoiceTable() {
            const tbody = document.getElementById('invoiceTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            invoices.forEach(inv => {
                const row = tbody.insertRow();
                const today = new Date();
                today.setHours(0,0,0,0);
                const dueDate = new Date(inv.dueDate);
                
                let statusClass = 'status-pending';
                if (inv.status === 'paid') {
                    statusClass = 'status-paid';
                } else if (dueDate < today) {
                    statusClass = 'status-overdue';
                }

                row.innerHTML = `<td>${inv.invoiceNumber}</td><td>${inv.supplierName}</td><td>$${(inv.amount||0).toFixed(2)}</td>
                    <td>${formatDate(inv.entryDate)}</td><td>${formatDate(inv.dueDate)}</td><td>${inv.costCenter||'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${inv.status}</span></td>
                    <td class="action-buttons">
                        ${inv.status !== 'paid' ? `<button class="icon-btn" style="background:#d1fae5; color:#065f46;" onclick="payInvoice(${inv.id})"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-width="2" d="M20 6L9 17l-5-5"></path></svg></button>` : ''}
                        ${inv.bsaleId ? `<button class="icon-btn" style="background:#fef3c7; color:#92400e;" title="Ver DTE de Compra" onclick="viewDTE(${inv.bsaleId})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></button>` : ''}
                        <button class="icon-btn" style="background:#dbeafe; color:#1e40af;" onclick="generatePDF(${inv.id})"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-width="2" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></button>
                        <button class="icon-btn" style="background:#fee2e2; color:#991b1b;" onclick="deleteInvoice(${inv.id})"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-width="2" d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </td>`;
            });
        }
        function updateSupplierSelect() {
            const select = document.getElementById('supplierSelect');
            if(!select) return;
            select.innerHTML = '<option value="">Seleccionar proveedor</option>';
            suppliers.forEach(s => select.add(new Option(s.name, s.id)));
        }
        function payInvoice(id) {
            currentPaymentInvoice = id;
            document.getElementById('paymentModal').classList.add('active');
            document.getElementById('paymentDate').valueAsDate = new Date();
        }
        function confirmPayment() {
            const invoice = invoices.find(inv => inv.id === currentPaymentInvoice);
            if (!invoice) return;
            const payment = { id: Date.now(), invoiceId: invoice.id, invoiceNumber: invoice.invoiceNumber, supplierName: invoice.supplierName, amount: invoice.amount, paymentDate: document.getElementById('paymentDate').value };
            payments.push(payment);
            localStorage.setItem('payments', JSON.stringify(payments));
            invoice.status = 'paid';
            localStorage.setItem('invoices', JSON.stringify(invoices));
            logAuditEvent('payment', `Pago registrado para factura ${invoice.invoiceNumber}`);
            updateAllViews();
            closePaymentModal();
            showAlert('Pago registrado.', 'success');
        }
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }
        function updatePaymentTable() {
            const tbody = document.getElementById('paymentTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            payments.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${formatDate(p.paymentDate)}</td><td>${p.invoiceNumber}</td><td>${p.supplierName}</td><td>$${(p.amount||0).toFixed(2)}</td><td>N/A</td><td>${currentUser.name}</td><td><button class="icon-btn" onclick="generateReceipt(${p.id})">üßæ</button></td>`;
            });
        }
        function searchPayments() { /* L√≥gica de b√∫squeda */ }
        function generatePDF(id) { showAlert(`Generando PDF para factura ID ${id}...`, 'info'); }
        function generateReceipt(id) { showAlert(`Generando recibo para pago ID ${id}...`, 'info'); }
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invoices), "Facturas");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suppliers), "Proveedores");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(payments), "Pagos");
            XLSX.writeFile(wb, `Exportacion-Pagos-${new Date().toISOString().split('T')[0]}.xlsx`);
            showAlert('Datos exportados a Excel.', 'success');
        }
        function deleteInvoice(id) {
            if (confirm('¬øEliminar esta factura?')) {
                invoices = invoices.filter(inv => inv.id !== id);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                updateAllViews();
                showAlert('Factura eliminada.', 'warning');
            }
        }
        function deleteSupplier(id) {
            if (invoices.some(inv => inv.supplierId == id)) {
                showAlert('No se puede eliminar, tiene facturas asociadas.', 'danger');
                return;
            }
            if (confirm('¬øEliminar este proveedor?')) {
                suppliers = suppliers.filter(s => s.id !== id);
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                updateAllViews();
                showAlert('Proveedor eliminado.', 'warning');
            }
        }
       
        function updateDashboard() {
            const pending = invoices.filter(inv => inv.status !== 'paid');
            document.getElementById('totalPending').textContent = `$${pending.reduce((sum, inv) => sum + (inv.amount || 0), 0).toFixed(2)}`;
            document.getElementById('overdueCount').textContent = pending.filter(inv => new Date(inv.dueDate) < new Date()).length;
            document.getElementById('supplierCount').textContent = suppliers.length;
        }
        function checkForReminders() { /* L√≥gica de recordatorios */ }
        function saveReminderSettings() { /* L√≥gica de guardado */ }

        // ============= INICIALIZACI√ìN DEL SISTEMA =============
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            const savedToken = localStorage.getItem('bsaleApiToken');
            if (savedToken) {
                document.getElementById('bsaleApiToken').value = savedToken;
            }

            updateAllViews();
            startAutoBackup();
            
            setInterval(updateBackupStatus, 60000);
            
            logAuditEvent('login', `Usuario ${currentUser.name} inici√≥ sesi√≥n.`);
        });

    </script>
</body>
</html>

